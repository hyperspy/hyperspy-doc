

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running and writing tests &mdash; HyperSpy 1.6.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/hyperspy.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/toggleprompt.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing documentation" href="writing_docs.html" />
    <link rel="prev" title="Using Git and GitHub" href="git.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> HyperSpy
          

          
            
            <img src="../_static/hyperspy_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.6.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">HyperSpy User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">﻿Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="git.html">Using Git and GitHub</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running and writing tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#writing-tests">Writing tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-tests">Running tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flaky-tests">Flaky tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-coverage">Test coverage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#continuous-integration-ci">Continuous integration (CI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-testing">Plot testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-pytest-results-as-html">Exporting pytest results as HTML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writing_docs.html">Writing documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding_style.html">Coding style</a></li>
<li class="toctree-l2"><a class="reference internal" href="lazy_computations.html">Tips for writing methods that work on lazy signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="speeding_up_code.html">Speeding up code</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_extensions.html">Writing packages that extend HyperSpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="useful_information.html">Useful information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">Full HyperSpy API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing HyperSpy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HyperSpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">HyperSpy Developer Guide</a> &raquo;</li>
        
      <li>Running and writing tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_guide/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-and-writing-tests">
<span id="testing-label"></span><h1>Running and writing tests<a class="headerlink" href="#running-and-writing-tests" title="Permalink to this headline">¶</a></h1>
<div class="section" id="writing-tests">
<h2>Writing tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h2>
<p>Every new function that is written in to HyperSpy should be tested and
documented. HyperSpy uses the <a class="reference external" href="http://doc.pytest.org/">pytest</a> library
for testing. The tests reside in the <code class="docutils literal notranslate"><span class="pre">hyperspy.tests</span></code> module.</p>
<p>Tests are short functions, found in <code class="docutils literal notranslate"><span class="pre">hyperspy/tests</span></code>, that call your functions
under some known conditions and check the outputs against known values. They
should depend on as few other features as possible so that when they break
we know exactly what caused it. Ideally, the tests should be written at the
same time than the code itself, as they are very convenient to run to check
outputs when coding. Writing tests can seem laborious but you’ll probably
soon find that they are very important, as they force you to sanity-check
all the work that you do.</p>
<p><strong>Useful testing hints:</strong></p>
<ul class="simple">
<li><p>When comparing integers, it’s fine to use <code class="docutils literal notranslate"><span class="pre">==</span></code></p></li>
<li><p>When comparing floats, be sure to use <code class="xref py py-meth docutils literal notranslate"><span class="pre">np.testing.assert_allclose()</span></code>
or <code class="xref py py-meth docutils literal notranslate"><span class="pre">np.testing.assert_almost_equal()</span></code></p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">np.testing.assert_allclose()</span></code> is also convenient for comparing
numpy arrays</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">hyperspy.misc.test_utils.py</span></code> contains a few useful functions for
testing</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize()</span></code> is a very convenient decorator to test several
parameters of the same function without having to write to much repetitive
code, which is often error-prone. See <a class="reference external" href="http://doc.pytest.org/en/latest/parametrize.html">pytest documentation</a> for more details.</p></li>
<li><p>It is good to check that the tests does not use too much memory after
creating new tests. If you need to explicitly delete your objects and free
memory, you can do the following to release the memory associated with the
<code class="docutils literal notranslate"><span class="pre">s</span></code> object:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">gc</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Do some work with the object</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="o">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Clear the memory</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">s</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>First ensure pytest and its plugins are installed by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># If using a standard hyperspy install</span>
$ pip install hyperspy<span class="o">[</span>tests<span class="o">]</span>

<span class="c1"># Or, from a hyperspy local development directory</span>
$ pip install -e .<span class="o">[</span>tests<span class="o">]</span>

<span class="c1"># Or just installing the dependencies using conda</span>
$ conda install -c conda-forge pytest pytest-mpl
</pre></div>
</div>
<p>To run them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pytest --mpl --pyargs hyperspy
</pre></div>
</div>
<p>Or, from HyperSpy’s project folder, simply:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pytest
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>pytest configuration options are set in the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> file, under the
<code class="docutils literal notranslate"><span class="pre">[tool:pytest]</span></code> section. See the <a class="reference external" href="https://docs.pytest.org/en/latest/customize.html">pytest configuration documentation</a> for more details.</p>
</div>
<p>The HyperSpy test suite can also be run in parallel if you have multiple CPUs
available, using the <code class="docutils literal notranslate"><span class="pre">`pytest-xdist</span></code> plugin &lt;<a class="reference external" href="https://pypi.org/project/pytest-xdist/">https://pypi.org/project/pytest-xdist/</a>&gt;`_.
If you have the plugin installed, HyperSpy will automatically run the test suite in
parallel on your machine.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To run on all the cores of your machine</span>
$ pytest -n auto --dist loadfile

<span class="c1"># To run on 2 cores</span>
$ pytest -n <span class="m">2</span> --dist loadfile
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--dist</span> <span class="pre">loadfile</span></code> argument will group tests by their containing file. The
groups are then distributed to available workers as whole units, thus guaranteeing
that all tests in a file run in the same worker.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running tests in parallel using <code class="docutils literal notranslate"><span class="pre">pytest-xdist</span></code> will change the content
and format of the output of <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to the console. We recommend installing
<code class="docutils literal notranslate"><span class="pre">`pytest-sugar</span></code> &lt;<a class="reference external" href="https://pypi.org/project/pytest-sugar/">https://pypi.org/project/pytest-sugar/</a>&gt;`_ to produce
nicer-looking output including an animated progressbar.</p>
</div>
</div>
<div class="section" id="flaky-tests">
<h2>Flaky tests<a class="headerlink" href="#flaky-tests" title="Permalink to this headline">¶</a></h2>
<p>Test functions can sometimes exhibit intermittent or sporadic failure, with seemingly
random or non-deterministic behaviour. They may sometimes pass or sometimes fail, and
it won’t always be clear why. These are usually known as “flaky” tests.</p>
<p>One way to approach flaky tests is to rerun them, to see if the failure was a one-off.
This can be achieved using the <code class="docutils literal notranslate"><span class="pre">`pytest-rerunfailures</span></code> plugin &lt;<a class="reference external" href="https://pypi.org/project/pytest-rerunfailures/">https://pypi.org/project/pytest-rerunfailures/</a>&gt;`_.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To re-run all test suite failures a maximum of 3 times</span>
$ pytest --reruns <span class="m">3</span>

<span class="c1"># To wait 1 second before the next retry</span>
$ pytest --reruns <span class="m">3</span> --reruns-delay <span class="m">1</span>
</pre></div>
</div>
<p>You can read more about flaky tests in the <a class="reference external" href="https://docs.pytest.org/en/stable/flaky.html">pytest documentation</a>.</p>
</div>
<div class="section" id="test-coverage">
<h2>Test coverage<a class="headerlink" href="#test-coverage" title="Permalink to this headline">¶</a></h2>
<p>Once you have pushed your pull request to the official HyperSpy repository,
you can see the coverage of your tests using the
<a class="reference external" href="https://codecov.io/gh/hyperspy/hyperspy">codecov.io</a> check for
your PR. There should be a link to it at the bottom of your PR on the Github
PR page. This service can help you to find how well your code is being tested
and exactly which parts are not currently tested.</p>
<p>You can also measure code coverage locally. If you have installed <code class="docutils literal notranslate"><span class="pre">pytest-cov</span></code>,
you can run (from HyperSpy’s project folder):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pytest --cov<span class="o">=</span>hyperspy
</pre></div>
</div>
<p>Configuration options for code coverage are also set in the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> file,
under the <code class="docutils literal notranslate"><span class="pre">[coverage:run]</span></code> and <code class="docutils literal notranslate"><span class="pre">[coverage:report]</span></code> sections. See the <a class="reference external" href="https://coverage.readthedocs.io/en/coverage-5.1/config.html">coverage
documentation</a>
for more details.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://codecov.io/gh/hyperspy/hyperspy">codecov.io</a> check in your
PR will fail if it either decreases the overall test coverage of HyperSpy,
or if any of the lines introduced in your diff are not covered.</p>
</div>
</div>
<div class="section" id="continuous-integration-ci">
<h2>Continuous integration (CI)<a class="headerlink" href="#continuous-integration-ci" title="Permalink to this headline">¶</a></h2>
<p>The HyperSpy test suite is run using continuous integration services provided by
<a class="reference external" href="https://github.com/hyperspy/hyperspy/actions">Github Actions</a> and
<a class="reference external" href="https://dev.azure.com/franciscode-la-pena-manchon/hyperspy/_build">Azure Pipelines</a>.
In case of Azure Pipelines, CI helper scripts are pulled from the
<a class="reference external" href="https://github.com/hyperspy/ci-scripts">ci-scripts</a> repository.</p>
<p>The testing matrix is as follows:</p>
<ul class="simple">
<li><p><strong>Github Actions</strong>: test a range of Pythons version on Linux, MacOS and Windows;
all dependencies are installed from <a class="reference external" href="https://pypi.org">PyPI</a>.
See <code class="docutils literal notranslate"><span class="pre">.github/workflows/tests.yml</span></code> in the HyperSpy repository for further details.</p></li>
<li><p><strong>Azure Pipeline</strong>: test a range of Python versions on Linux, MacOS and Windows;
all dependencies are installed from <a class="reference external" href="https://anaconda.org/">Anaconda Cloud</a>
using the <a class="reference external" href="https://anaconda.org/anaconda">Anaconda “defaults”</a> and the
<a class="reference external" href="https://anaconda.org/conda-forge">“conda-forge”</a> channel (in this order of
priority). See <code class="docutils literal notranslate"><span class="pre">azure-pipelines.yml</span></code> in the HyperSpy repository for further details.</p></li>
</ul>
<p>This testing matrix has been designed to be simple and easy to maintain, whilst
ensuring that packages from PyPI and Anaconda cloud are not mixed in order to
avoid red herring failures of the test suite caused by application binary
interface (ABI) incompatibility between dependencies.</p>
<p>The most recent versions of packages are usually available first on PyPI, before
they are available on Anaconda Cloud. These means that if a recent release of a
dependency breaks the test suite, it should happen first on Github Actions.
Similarly, deprecation warnings will usually appear first on Github Actions.</p>
<p>The documentation build is done on both Github Actions and
<a class="reference external" href="https://readthedocs.org/">Read the Docs</a>, and it is worth checking that no new
warnings have been introduced when writing documentation in the user guide or
in the docstrings.</p>
<p>The Github Actions testing matrix also includes the following special cases:</p>
<ul class="simple">
<li><p>The test suite is run against HyperSpy’s minimum requirements on Python 3.7
on Linux. This will skip any tests that require <strong>optional</strong> packages such as
<code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>.</p></li>
<li><p>The test suite is run against the oldest supported versions of <code class="docutils literal notranslate"><span class="pre">numpy</span></code>,
<code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">scipy</span></code>. For more details, see this
<a class="reference external" href="https://github.com/hyperspy/hyperspy/pull/2485">Github issue</a>.</p></li>
</ul>
</div>
<div class="section" id="plot-testing">
<span id="plot-test-label"></span><h2>Plot testing<a class="headerlink" href="#plot-testing" title="Permalink to this headline">¶</a></h2>
<p>Plotting is tested using the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator of
the <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest mpl plugin</a>.  This
decorator uses reference images to compare with the generated output during the
tests. The reference images are located in the folder defined by the argument
<code class="docutils literal notranslate"><span class="pre">baseline_dir</span></code> of the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator.</p>
<p>To run plot tests, you simply need to add the option <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>:</p>
<p>:: code:: bash</p>
<blockquote>
<div><p>$ pytest –mpl</p>
</div></blockquote>
<p>If you don’t use <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>, the test functions will be executed, but the
images will not be compared to the reference images.</p>
<p>If you need to add or change some plots, follow the workflow below:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Write the tests using appropriate decorators such as
<code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code>.</p></li>
<li><p>If you need to generate a new reference image in the folder
<code class="docutils literal notranslate"><span class="pre">plot_test_dir</span></code>, for example, run: <code class="docutils literal notranslate"><span class="pre">pytest</span>
<span class="pre">--mpl-generate-path=plot_test_dir</span></code></p></li>
<li><p>Run again the tests and this time they should pass.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> to put the new file in the git repository.</p></li>
</ol>
</div></blockquote>
<p>When the plotting tests fail, it is possible to download the figure
comparison images generated by <code class="docutils literal notranslate"><span class="pre">pytest-mpl</span></code> in the artifacts tabs of the
corresponding build on Azure Pipeliness:</p>
<div class="figure align-default">
<img alt="../_images/azure_pipeline_artifacts.png" src="../_images/azure_pipeline_artifacts.png" />
</div>
<p>The plotting tests are tested on Azure Pipelines against a specific version of
matplotlib defined in <code class="docutils literal notranslate"><span class="pre">conda_environment_dev.yml</span></code>. This is because small
changes in the way matplotlib generates the figure between versions can sometimes
make the tests fail.</p>
<p>For plotting tests, the matplotlib backend is set to <code class="docutils literal notranslate"><span class="pre">agg</span></code> by setting
the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">agg</span></code>. At the first import of
<code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code>, matplotlib will look at the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment
variable and accordingly set the backend.</p>
</div>
<div class="section" id="exporting-pytest-results-as-html">
<h2>Exporting pytest results as HTML<a class="headerlink" href="#exporting-pytest-results-as-html" title="Permalink to this headline">¶</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">pytest-html</span></code> it is possible to export the results of running pytest
for easier viewing. It can be installed by conda:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda install pytest-html
</pre></div>
</div>
<p>and run by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pytest --mpl --html<span class="o">=</span>report.html
</pre></div>
</div>
<p>See <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest-mpl</a> for more details.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="writing_docs.html" class="btn btn-neutral float-right" title="Writing documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="git.html" class="btn btn-neutral float-left" title="Using Git and GitHub" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2011-2020, The HyperSpy development team

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>