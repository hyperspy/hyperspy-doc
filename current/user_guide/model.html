<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Model fitting &mdash; HyperSpy 1.7.3 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/hyperspy.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/toggleprompt.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Electron Energy Loss Spectroscopy" href="eels.html" />
    <link rel="prev" title="Machine learning" href="mva.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> HyperSpy
            <img src="../_static/hyperspy_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.7.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing HyperSpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">The Signal class</a></li>
<li class="toctree-l1"><a class="reference internal" href="axes.html">Axes handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactive_operations_ROIs.html">Interactive Operations and Region of Interest (ROI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal1d.html">Signal1D Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal2d.html">Signal2D Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="mva.html">Machine learning</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Model fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#caveats">Caveats</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-model">Creating a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-components">Model components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-defined-model-components">Pre-defined model components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-components-from-a-mathematical-expression">Define components from a mathematical expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-new-components-from-a-python-function">Define new components from a Python function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-components-from-a-fixed-pattern">Define components from a fixed-pattern</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-components-to-the-model">Adding components to the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#indexing-the-model">Indexing the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#getting-and-setting-parameter-values-and-attributes">Getting and setting parameter values and attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fitting-the-model-to-the-data">Fitting the model to the data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#optimization-algorithms">Optimization algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loss-functions">Loss functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#least-squares-with-error-estimation">Least squares with error estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#weighted-least-squares-with-error-estimation">Weighted least squares with error estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#poisson-maximum-likelihood-estimation">Poisson maximum likelihood estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#huber-loss-function">Huber loss function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-loss-functions">Custom loss functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-gradient-information">Using gradient information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bounded-optimization">Bounded optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linear-least-squares">Linear least squares</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimization-results">Optimization results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#goodness-of-fit">Goodness of fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualizing-the-model">Visualizing the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-initial-parameters">Setting the initial parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exclude-data-from-the-fitting-process">Exclude data from the fitting process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-multidimensional-datasets">Fitting multidimensional datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualising-the-result-of-the-fit">Visualising the result of the fit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#storing-models">Storing models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#saving-and-loading-the-result-of-the-fit">Saving and loading the result of the fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-the-result-of-the-fit">Exporting the result of the fit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#batch-setting-of-parameter-attributes">Batch setting of parameter attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fitting-big-data">Fitting big data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#smart-adaptive-multi-dimensional-fitting-samfire">Smart Adaptive Multi-dimensional Fitting (SAMFire)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-idea">The idea</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strategies">Strategies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#local-strategy-family">Local strategy family</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-strategy-family">Global strategy family</a></li>
<li class="toctree-l3"><a class="reference internal" href="#seed-points">Seed points</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="eels.html">Electron Energy Loss Spectroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="eds.html">Energy-Dispersive X-ray Spectrometry (EDS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dielectric_function.html">Dielectric function tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="electron_holography.html">Electron Holography</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">Loading and saving data</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="big_data.html">Working with big data</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata_structure.html">Metadata structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/git.html">Using Git and GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/testing.html">Running and writing tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/writing_docs.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/coding_style.html">Coding style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/lazy_computations.html">Tips for writing methods that work on lazy signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/speeding_up_code.html">Speeding up code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/writing_extensions.html">Writing packages that extend HyperSpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/useful_information.html">Useful information</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">hyperspy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Credits and citation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing HyperSpy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HyperSpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Model fitting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user_guide/model.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="model-fitting">
<span id="model-label"></span><h1>Model fitting<a class="headerlink" href="#model-fitting" title="Permalink to this heading"></a></h1>
<p>HyperSpy can perform curve fitting of one-dimensional signals (spectra) and
two-dimensional signals (images) in <cite>n</cite>-dimensional data sets.
Models are defined by adding individual functions (components in HyperSpy’s
terminology) to a <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a> instance. Those individual
components are then summed to create the final model function that can be
fitted to the data, by adjusting the free parameters of the individual
components.</p>
<p>Models can be created and fit to experimental data in both one and two
dimensions i.e. spectra and images respectively. Most of the syntax is
identical in either case. A one-dimensional model is created when a model
is created for a <a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D" title="hyperspy._signals.signal1d.Signal1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code></a> whereas a two-
dimensional model is created for a <a class="reference internal" href="../api/hyperspy._signals.signal2d.html#hyperspy._signals.signal2d.Signal2D" title="hyperspy._signals.signal2d.Signal2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal2D</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Plotting and analytical gradient-based fitting methods are not yet
implemented for the <a class="reference internal" href="../api/hyperspy.models.model2d.html#hyperspy.models.model2d.Model2D" title="hyperspy.models.model2d.Model2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model2D</span></code></a> class.</p>
</div>
<section id="caveats">
<h2>Caveats<a class="headerlink" href="#caveats" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Before creating a model verify that the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">is_binned</span></code> attribute
of the signal axis is set to the correct value because the resulting
model depends on this parameter. See <a class="reference internal" href="signal.html#signal-binned"><span class="std std-ref">Binned and unbinned signals</span></a> for more details.</p></li>
<li><p>When importing data that has been binned using other software, in
particular Gatan’s DM, the stored values may be the averages of the
binned channels or pixels, instead of their sum, as would be required
for proper statistical analysis. We therefore cannot guarantee that
the statistics will be valid, and so strongly recommend that all
pre-fitting binning is performed using Hyperspy.</p></li>
</ul>
</section>
<section id="creating-a-model">
<h2>Creating a model<a class="headerlink" href="#creating-a-model" title="Permalink to this heading"></a></h2>
<p>A <a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D" title="hyperspy.models.model1d.Model1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model1D</span></code></a> can be created for data in the
<a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D" title="hyperspy._signals.signal1d.Signal1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code></a> class using the
<a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D.create_model" title="hyperspy._signals.signal1d.Signal1D.create_model"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_model()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span> <span class="c1"># Creates the 1D-Model and assign it to m</span>
</pre></div>
</div>
<p>Similarly, a <a class="reference internal" href="../api/hyperspy.models.model2d.html#hyperspy.models.model2d.Model2D" title="hyperspy.models.model2d.Model2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model2D</span></code></a> can be created for data
in the <a class="reference internal" href="../api/hyperspy._signals.signal2d.html#hyperspy._signals.signal2d.Signal2D" title="hyperspy._signals.signal2d.Signal2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal2D</span></code></a> class using the
<a class="reference internal" href="../api/hyperspy._signals.signal2d.html#hyperspy._signals.signal2d.Signal2D.create_model" title="hyperspy._signals.signal2d.Signal2D.create_model"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_model()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mod</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span> <span class="c1"># Create the 2D-Model and assign it to mod</span>
</pre></div>
</div>
<p>The syntax for creating both one-dimensional and two-dimensional models is thus
identical for the user in practice. When a model is created  you may be
prompted to provide important information not already included in the
datafile, <cite>e.g.</cite> if <code class="docutils literal notranslate"><span class="pre">s</span></code> is EELS data, you may be asked for the accelerating
voltage, convergence and collection semi-angles etc.</p>
</section>
<section id="model-components">
<h2>Model components<a class="headerlink" href="#model-components" title="Permalink to this heading"></a></h2>
<p>In HyperSpy a model consists of a sum of individual components. For convenience,
HyperSpy provides a number of pre-defined model components as well as mechanisms
to create your own components.</p>
<section id="pre-defined-model-components">
<span id="model-components-label"></span><h3>Pre-defined model components<a class="headerlink" href="#pre-defined-model-components" title="Permalink to this heading"></a></h3>
<p>Various components are available in one (<a class="reference internal" href="../api/hyperspy.components1d.html#module-hyperspy.components1d" title="hyperspy.components1d"><code class="xref py py-mod docutils literal notranslate"><span class="pre">components1d</span></code></a>) and
two-dimensions (<a class="reference internal" href="../api/hyperspy.components2d.html#module-hyperspy.components2d" title="hyperspy.components2d"><code class="xref py py-mod docutils literal notranslate"><span class="pre">components2d</span></code></a>) to construct a
model.</p>
<p>The following general components are currently available for one-dimensional models:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/hyperspy._components.arctan.html#hyperspy._components.arctan.Arctan" title="hyperspy._components.arctan.Arctan"><code class="xref py py-class docutils literal notranslate"><span class="pre">Arctan</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.bleasdale.html#hyperspy._components.bleasdale.Bleasdale" title="hyperspy._components.bleasdale.Bleasdale"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bleasdale</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.doniach.html#hyperspy._components.doniach.Doniach" title="hyperspy._components.doniach.Doniach"><code class="xref py py-class docutils literal notranslate"><span class="pre">Doniach</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.error_function.html#hyperspy._components.error_function.Erf" title="hyperspy._components.error_function.Erf"><code class="xref py py-class docutils literal notranslate"><span class="pre">Erf</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.exponential.html#hyperspy._components.exponential.Exponential" title="hyperspy._components.exponential.Exponential"><code class="xref py py-class docutils literal notranslate"><span class="pre">Exponential</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.expression.html#hyperspy._components.expression.Expression" title="hyperspy._components.expression.Expression"><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.gaussian.html#hyperspy._components.gaussian.Gaussian" title="hyperspy._components.gaussian.Gaussian"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.gaussianhf.html#hyperspy._components.gaussianhf.GaussianHF" title="hyperspy._components.gaussianhf.GaussianHF"><code class="xref py py-class docutils literal notranslate"><span class="pre">GaussianHF</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.heaviside.html#hyperspy._components.heaviside.HeavisideStep" title="hyperspy._components.heaviside.HeavisideStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">HeavisideStep</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.logistic.html#hyperspy._components.logistic.Logistic" title="hyperspy._components.logistic.Logistic"><code class="xref py py-class docutils literal notranslate"><span class="pre">Logistic</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.lorentzian.html#hyperspy._components.lorentzian.Lorentzian" title="hyperspy._components.lorentzian.Lorentzian"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lorentzian</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.offset.html#hyperspy._components.offset.Offset" title="hyperspy._components.offset.Offset"><code class="xref py py-class docutils literal notranslate"><span class="pre">Offset</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.polynomial.html#hyperspy._components.polynomial.Polynomial" title="hyperspy._components.polynomial.Polynomial"><code class="xref py py-class docutils literal notranslate"><span class="pre">Polynomial</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.power_law.html#hyperspy._components.power_law.PowerLaw" title="hyperspy._components.power_law.PowerLaw"><code class="xref py py-class docutils literal notranslate"><span class="pre">PowerLaw</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.pes_see.html#hyperspy._components.pes_see.SEE" title="hyperspy._components.pes_see.SEE"><code class="xref py py-class docutils literal notranslate"><span class="pre">SEE</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.scalable_fixed_pattern.html#hyperspy._components.scalable_fixed_pattern.ScalableFixedPattern" title="hyperspy._components.scalable_fixed_pattern.ScalableFixedPattern"><code class="xref py py-class docutils literal notranslate"><span class="pre">ScalableFixedPattern</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.skew_normal.html#hyperspy._components.skew_normal.SkewNormal" title="hyperspy._components.skew_normal.SkewNormal"><code class="xref py py-class docutils literal notranslate"><span class="pre">SkewNormal</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.voigt.html#hyperspy._components.voigt.Voigt" title="hyperspy._components.voigt.Voigt"><code class="xref py py-class docutils literal notranslate"><span class="pre">Voigt</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.split_voigt.html#hyperspy._components.split_voigt.SplitVoigt" title="hyperspy._components.split_voigt.SplitVoigt"><code class="xref py py-class docutils literal notranslate"><span class="pre">SplitVoigt</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.volume_plasmon_drude.html#hyperspy._components.volume_plasmon_drude.VolumePlasmonDrude" title="hyperspy._components.volume_plasmon_drude.VolumePlasmonDrude"><code class="xref py py-class docutils literal notranslate"><span class="pre">VolumePlasmonDrude</span></code></a></p></li>
</ul>
<p>The following components developed with specific signal types in mind are
currently available for one-dimensional models:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/hyperspy._components.eels_arctan.html#hyperspy._components.eels_arctan.EELSArctan" title="hyperspy._components.eels_arctan.EELSArctan"><code class="xref py py-class docutils literal notranslate"><span class="pre">EELSArctan</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.eels_double_power_law.html#hyperspy._components.eels_double_power_law.DoublePowerLaw" title="hyperspy._components.eels_double_power_law.DoublePowerLaw"><code class="xref py py-class docutils literal notranslate"><span class="pre">DoublePowerLaw</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.eels_cl_edge.html#hyperspy._components.eels_cl_edge.EELSCLEdge" title="hyperspy._components.eels_cl_edge.EELSCLEdge"><code class="xref py py-class docutils literal notranslate"><span class="pre">EELSCLEdge</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.pes_core_line_shape.html#hyperspy._components.pes_core_line_shape.PESCoreLineShape" title="hyperspy._components.pes_core_line_shape.PESCoreLineShape"><code class="xref py py-class docutils literal notranslate"><span class="pre">PESCoreLineShape</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.pes_voigt.html#hyperspy._components.pes_voigt.PESVoigt" title="hyperspy._components.pes_voigt.PESVoigt"><code class="xref py py-class docutils literal notranslate"><span class="pre">PESVoigt</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.pes_see.html#hyperspy._components.pes_see.SEE" title="hyperspy._components.pes_see.SEE"><code class="xref py py-class docutils literal notranslate"><span class="pre">SEE</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.eels_vignetting.html#hyperspy._components.eels_vignetting.Vignetting" title="hyperspy._components.eels_vignetting.Vignetting"><code class="xref py py-class docutils literal notranslate"><span class="pre">Vignetting</span></code></a></p></li>
</ul>
<p>The following components are currently available for two-dimensional models:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/hyperspy._components.expression.html#hyperspy._components.expression.Expression" title="hyperspy._components.expression.Expression"><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy._components.gaussian2d.html#hyperspy._components.gaussian2d.Gaussian2D" title="hyperspy._components.gaussian2d.Gaussian2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian2D</span></code></a></p></li>
</ul>
<p>However, this doesn’t mean that you have to limit yourself to this meagre
list of functions. As discussed below, it is very easy to turn a
mathematical, fixed-pattern or Python function into a component.</p>
</section>
<section id="define-components-from-a-mathematical-expression">
<span id="expression-component-label"></span><h3>Define components from a mathematical expression<a class="headerlink" href="#define-components-from-a-mathematical-expression" title="Permalink to this heading"></a></h3>
<p>The easiest way to turn a mathematical expression into a component is using the
<a class="reference internal" href="../api/hyperspy._components.expression.html#hyperspy._components.expression.Expression" title="hyperspy._components.expression.Expression"><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code></a> component. For example, the
following is all you need to create a
<a class="reference internal" href="../api/hyperspy._components.gaussian.html#hyperspy._components.gaussian.Gaussian" title="hyperspy._components.gaussian.Gaussian"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code></a> component  with more sensible
parameters for spectroscopy than the one that ships with HyperSpy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="n">expression</span><span class="o">=</span><span class="s2">&quot;height * exp(-(x - x0) ** 2 * 4 * log(2)/ fwhm ** 2)&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span><span class="n">fwhm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span><span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="gp">... </span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the expression is inconvenient to write out in full (e.g. it’s long and/or
complicated), multiple substitutions can be given, separated by semicolons.
Both symbolic and numerical substitutions are allowed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;h / sqrt(p2) ; p2 = 2 * m0 * e1 * x * brackets;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">+=</span> <span class="s2">&quot;brackets = 1 + (e1 * x) / (2 * m0 * c * c) ;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">+=</span> <span class="s2">&quot;m0 = 9.1e-31 ; c = 3e8; e1 = 1.6e-19 ; h = 6.6e-34&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="n">expression</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span>
<span class="gp">... </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Electron wavelength with voltage&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../api/hyperspy._components.expression.html#hyperspy._components.expression.Expression" title="hyperspy._components.expression.Expression"><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code></a> uses <a class="reference external" href="https://www.sympy.org">Sympy</a> internally to turn the string into
a function. By default it “translates” the expression using
numpy, but often it is possible to boost performance by using
<a class="reference external" href="https://github.com/pydata/numexpr">numexpr</a> instead.</p>
<p>It can also create 2D components with optional rotation. In the following
example we create a 2D Gaussian that rotates around its center:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components2D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="s2">&quot;k * exp(-((x-x0)**2 / (2 * sx ** 2) + (y-y0)**2 / (2 * sy ** 2)))&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="s2">&quot;Gaussian2d&quot;</span><span class="p">,</span> <span class="n">add_rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;y0&quot;</span><span class="p">),</span>
<span class="gp">... </span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-new-components-from-a-python-function">
<h3>Define new components from a Python function<a class="headerlink" href="#define-new-components-from-a-python-function" title="Permalink to this heading"></a></h3>
<p>Of course <a class="reference internal" href="../api/hyperspy._components.expression.html#hyperspy._components.expression.Expression" title="hyperspy._components.expression.Expression"><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code></a> is only useful for
analytical functions. You can define more general components modifying the
following template to suit your needs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hyperspy.component</span> <span class="kn">import</span> <span class="n">Component</span>

<span class="k">class</span> <span class="nc">MyComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">parameter_2</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># Define the parameters</span>
        <span class="n">Component</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;parameter_1&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter_2&#39;</span><span class="p">))</span>

        <span class="c1"># Optionally we can set the initial values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">parameter_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">parameter_2</span>

        <span class="c1"># The units (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Tesla&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Kociak&#39;</span>

        <span class="c1"># Once defined we can give default values to the attribute</span>
        <span class="c1"># For example we fix the attribure_1 (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">attribute_1</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># And we set the boundaries (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">bmax</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Optionally, to boost the optimization speed we can also define</span>
        <span class="c1"># the gradients of the function we the syntax:</span>
        <span class="c1"># self.parameter.grad = function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_parameter_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_parameter_2</span>

    <span class="c1"># Define the function as a function of the already defined parameters,</span>
    <span class="c1"># x being the independent variable value</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">value</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">p2</span>

    <span class="c1"># Optionally define the gradients of each parameter</span>
    <span class="k">def</span> <span class="nf">grad_parameter_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns d(function)/d(parameter_1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">grad_parameter_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns d(function)/d(parameter_2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</section>
<section id="define-components-from-a-fixed-pattern">
<h3>Define components from a fixed-pattern<a class="headerlink" href="#define-components-from-a-fixed-pattern" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="../api/hyperspy._components.scalable_fixed_pattern.html#hyperspy._components.scalable_fixed_pattern.ScalableFixedPattern" title="hyperspy._components.scalable_fixed_pattern.ScalableFixedPattern"><code class="xref py py-class docutils literal notranslate"><span class="pre">ScalableFixedPattern</span></code></a>
component enables fitting a pattern (in the form of a
<a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D" title="hyperspy._signals.signal1d.Signal1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code></a> instance) to data by shifting
(<code class="xref py py-attr docutils literal notranslate"><span class="pre">shift</span></code>)
and
scaling it in the x and y directions using the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">xscale</span></code>
and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">yscale</span></code>
parameters respectively.</p>
</section>
</section>
<section id="adding-components-to-the-model">
<h2>Adding components to the model<a class="headerlink" href="#adding-components-to-the-model" title="Permalink to this heading"></a></h2>
<p>To print the current components in a model use
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.components" title="hyperspy.model.BaseModel.components"><code class="xref py py-attr docutils literal notranslate"><span class="pre">components</span></code></a>. A table with component number,
attribute name, component name and component type will be printed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">&lt;Model, title: my signal title&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span> <span class="c1"># an empty model</span>
<span class="go">   # |       Attribute Name |       Component Name |        Component Type</span>
<span class="go">---- | -------------------- | -------------------- | ---------------------</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes components may be created automatically. For example, if
the <a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D" title="hyperspy._signals.signal1d.Signal1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code></a> is recognised as EELS data, a
power-law background component may automatically be added to the model.
Therefore, the table above may not all may empty on model creation.</p>
</div>
<p>To add a component to the model, first we have to create an instance of the
component.
Once the instance has been created we can add the component to the model
using the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.append" title="hyperspy.model.BaseModel.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">append()</span></code></a> and
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.extend" title="hyperspy.model.BaseModel.extend"><code class="xref py py-meth docutils literal notranslate"><span class="pre">extend()</span></code></a> methods for one or more components
respectively.</p>
<p>As an example, let’s add several <a class="reference internal" href="../api/hyperspy._components.gaussian.html#hyperspy._components.gaussian.Gaussian" title="hyperspy._components.gaussian.Gaussian"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code></a>
components to the model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create a Gaussian comp.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaussian</span><span class="p">)</span> <span class="c1"># Add it to the model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span> <span class="c1"># Print the model components</span>
<span class="go">   # |       Attribute Name |        Component Name |        Component Type</span>
<span class="go">---- | -------------------- | --------------------- | ---------------------</span>
<span class="go">   0 |             Gaussian |              Gaussian |              Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create another gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create a third gaussian</span>
</pre></div>
</div>
<p>We could use the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.append" title="hyperspy.model.BaseModel.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">append()</span></code></a> method twice to add the
two Gaussians, but when adding multiple components it is handier to use the
extend method that enables adding a list of components at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">gaussian2</span><span class="p">,</span> <span class="n">gaussian3</span><span class="p">))</span> <span class="c1"># note the double parentheses!</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |       Attribute Name |      Component Name |        Component Type</span>
<span class="go">---- | -------------------- | ------------------- | ---------------------</span>
<span class="go">   0 |             Gaussian |            Gaussian |              Gaussian</span>
<span class="go">   1 |           Gaussian_0 |          Gaussian_0 |              Gaussian</span>
<span class="go">   2 |           Gaussian_1 |          Gaussian_1 |              Gaussian</span>
</pre></div>
</div>
<p>We can customise the name of the components.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Carbon&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Long Hydrogen name&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Nitrogen&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |        Attribute Name |        Component Name |      Component Type</span>
<span class="go">---- | --------------------- | --------------------- | -------------------</span>
<span class="go">   0 |                Carbon |                Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |    Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |              Nitrogen |            Gaussian</span>
</pre></div>
</div>
<p>Notice that two components cannot have the same name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Carbon&#39;</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;ipython-input-5-2b5669fae54a&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">g2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Carbon&quot;</span>
<span class="gr">  File &quot;/home/fjd29/Python/hyperspy/hyperspy/component.py&quot;, line 466, in</span>
<span class="gr">    name &quot;the name &quot; + str(value))</span>
<span class="gr">ValueError</span>: <span class="n">Another component already has the name Carbon</span>
</pre></div>
</div>
<p>It is possible to access the components in the model by their name or by the
index in the model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">   # |        Attribute Name |       Component Name |      Component Type</span>
<span class="go">---- | --------------------- | -------------------- | -------------------</span>
<span class="go">   0 |                Carbon |               Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |   Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |             Nitrogen |            Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&lt;Carbon (Gaussian component)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;Long Hydrogen name&quot;</span><span class="p">]</span>
<span class="go">&lt;Long Hydrogen name (Gaussian component)&gt;</span>
</pre></div>
</div>
<p>In addition, the components can be accessed in the
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.components" title="hyperspy.model.BaseModel.components"><code class="xref py py-attr docutils literal notranslate"><span class="pre">components</span></code></a> <cite>Model</cite> attribute. This is specially
useful when working in interactive data analysis with IPython because it
enables tab completion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">   # |        Attribute Name |        Component Name |      Component Type</span>
<span class="go">---- | --------------------- | --------------------- | -------------------</span>
<span class="go">   0 |                Carbon |                Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |    Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |              Nitrogen |            Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">Long_Hydrogen_name</span>
<span class="go">&lt;Long Hydrogen name (Gaussian component)&gt;</span>
</pre></div>
</div>
<p>It is possible to “switch off” a component by setting its
<code class="docutils literal notranslate"><span class="pre">active</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">False</span></code>. When a component is
switched off, to all effects it is as if it was not part of the model. To
switch it back on simply set the <code class="docutils literal notranslate"><span class="pre">active</span></code> attribute back to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>In multi-dimensional signals it is possible to store the value of the
<code class="docutils literal notranslate"><span class="pre">active</span></code> attribute at each navigation index.
To enable this feature for a given component set the
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.active_is_multidimensional" title="hyperspy.component.Component.active_is_multidimensional"><code class="xref py py-attr docutils literal notranslate"><span class="pre">active_is_multidimensional</span></code></a> attribute to
<cite>True</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">active_is_multidimensional</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([ True,  True,  True,  True,  True,  True,  True,  True,  True,  True], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">_active_array</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_component_active_value</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([False, False, False, False, False, False, False, False, False, False], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_component_active_value</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_current</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([ True, False, False, False, False, False, False, False, False, False], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">active_is_multidimensional</span> <span class="o">=</span> <span class="kc">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
<section id="indexing-the-model">
<span id="model-indexing-label"></span><h2>Indexing the model<a class="headerlink" href="#indexing-the-model" title="Permalink to this heading"></a></h2>
<p>Often it is useful to consider only part of the model - for example at
a particular location (i.e. a slice in the navigation space) or energy range
(i.e. a slice in the signal space). This can be done using exactly the same
syntax that we use for signal indexing (<a class="reference internal" href="signal.html#signal-indexing"><span class="std std-ref">Indexing</span></a>).
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.red_chisq" title="hyperspy.model.BaseModel.red_chisq"><code class="xref py py-attr docutils literal notranslate"><span class="pre">red_chisq</span></code></a> and <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.dof" title="hyperspy.model.BaseModel.dof"><code class="xref py py-attr docutils literal notranslate"><span class="pre">dof</span></code></a>
are automatically recomputed for the resulting slices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># select first three navigation pixels and last five signal channels</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">inav</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">isig</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">signal</span>
<span class="go">&lt;Signal1D, title: , dimensions: (3|5)&gt;</span>
</pre></div>
</div>
</section>
<section id="getting-and-setting-parameter-values-and-attributes">
<h2>Getting and setting parameter values and attributes<a class="headerlink" href="#getting-and-setting-parameter-values-and-attributes" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.print_current_values" title="hyperspy.model.BaseModel.print_current_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">print_current_values()</span></code></a> prints the properties of the
parameters of the components in the current coordinates. In the Jupyter Notebook,
the default view is HTML-formatted, which allows for formatted copying
into other software, such as Excel. This can be changed to a standard
terminal view with the argument <code class="docutils literal notranslate"><span class="pre">fancy=False</span></code>. One can also filter for only active
components and only showing component with free parameters with the arguments
<code class="docutils literal notranslate"><span class="pre">only_active</span></code> and <code class="docutils literal notranslate"><span class="pre">only_free</span></code>, respectively.</p>
<p id="component-print-current-values">The current values of a particular component can be printed using the
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.print_current_values" title="hyperspy.component.Component.print_current_values"><code class="xref py py-attr docutils literal notranslate"><span class="pre">print_current_values()</span></code></a> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">G</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">G</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Gaussian: Al_Ka</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min</span>
<span class="go">============== | ===== | ========== | ========== | ==========</span>
<span class="go">             A |  True | 62894.6824 | 1039.40944 |        0.0</span>
<span class="go">         sigma | False | 0.03253440 |       None |       None</span>
<span class="go">        centre | False |     1.4865 |       None |       None</span>
</pre></div>
</div>
<p>The current coordinates can be either set by navigating the
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.plot" title="hyperspy.model.BaseModel.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a>, or specified by pixel indices in
<code class="docutils literal notranslate"><span class="pre">m.axes_manager.indices</span></code> or as calibrated coordinates in
<code class="docutils literal notranslate"><span class="pre">m.axes_manager.coordinates</span></code>.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">parameters</span></code> contains a list of the parameters
of a component and <code class="xref py py-attr docutils literal notranslate"><span class="pre">free_parameters</span></code> lists only
the free parameters.</p>
<p>The value of a particular parameter in the current coordinates can be
accessed by <code class="xref py py-attr docutils literal notranslate"><span class="pre">component.Parameter.value</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">Gaussian.A.value</span></code>).
To access an array of the value of the parameter across all navigation
pixels, <code class="xref py py-attr docutils literal notranslate"><span class="pre">component.Parameter.map['values']</span></code> (e.g.
<code class="docutils literal notranslate"><span class="pre">Gaussian.A.map[&quot;values&quot;]</span></code>) can be used. On its own,
<code class="xref py py-attr docutils literal notranslate"><span class="pre">component.Parameter.map</span></code> returns a NumPy array with three elements:
<code class="docutils literal notranslate"><span class="pre">'values'</span></code>, <code class="docutils literal notranslate"><span class="pre">'std'</span></code> and <code class="docutils literal notranslate"><span class="pre">'is_set'</span></code>. The first two give the value and
standard error for each index. The last element shows whether the value has
been set in a given index, either by a fitting procedure or manually.</p>
<p>If a model contains several components with the same parameters, it is possible
to change them all by using <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_value" title="hyperspy.model.BaseModel.set_parameters_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_value()</span></code></a>.
Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">only_current</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 40.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="n">component_list</span><span class="o">=</span><span class="p">[</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 40.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
</pre></div>
</div>
<p>To set the <code class="docutils literal notranslate"><span class="pre">free</span></code> state of a parameter change the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">free</span></code> attribute. To change the <code class="docutils literal notranslate"><span class="pre">free</span></code> state
of all parameters in a component to <cite>True</cite> use
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.set_parameters_free" title="hyperspy.component.Component.set_parameters_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code></a>, and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.set_parameters_not_free" title="hyperspy.component.Component.set_parameters_not_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code></a> for setting them to
<code class="docutils literal notranslate"><span class="pre">False</span></code>. Specific parameter-names can also be specified by using
<code class="docutils literal notranslate"><span class="pre">parameter_name_list</span></code>, shown in the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">&lt;Parameter sigma of Gaussian component&gt;,</span>
<span class="go">&lt;Parameter centre of Gaussian component&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">set_parameters_not_free</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">(</span><span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;centre&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">&lt;Parameter centre of Gaussian component&gt;]</span>
</pre></div>
</div>
<p>Similar functions exist for <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a>:
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_free" title="hyperspy.model.BaseModel.set_parameters_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code></a> and
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_not_free" title="hyperspy.model.BaseModel.set_parameters_not_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code></a>. Which sets the
<code class="docutils literal notranslate"><span class="pre">free</span></code> states for the parameters in components in a model. Specific
components and parameter-names can also be specified. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_not_free</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">(</span><span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">([</span><span class="n">g1</span><span class="p">],</span> <span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">     &lt;Parameter sigma of Gaussian component&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">[&lt;Parameter A of Gaussian component&gt;]</span>
</pre></div>
</div>
<p>The value of a parameter can be coupled to the value of another by setting the
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin" title="hyperspy.component.Parameter.twin"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin</span></code></a> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># Print the parameters of the Gaussian components</span>
<span class="go">(&lt;Parameter A of Carbon component&gt;,</span>
<span class="go">&lt;Parameter sigma of Carbon component&gt;,</span>
<span class="go">&lt;Parameter centre of Carbon component&gt;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Fix the centre</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">free_parameters</span>  <span class="c1"># Print the free parameters</span>
<span class="go">[&lt;Parameter A of Carbon component&gt;, &lt;Parameter sigma of Carbon component&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">only_free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Print the values of all free parameters.</span>
<span class="go">Model1D:</span>
<span class="go">Gaussian: Carbon</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True |        1.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>

<span class="go">Gaussian: Long Hydrogen name</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True |        1.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>

<span class="go">Gaussian: Nitrogen</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True |        1.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Couple the A parameter of gaussian2 to the A parameter of gaussian 3:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin</span> <span class="o">=</span> <span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Set the gaussian2 A value to 10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Gaussian: Nitrogen</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True |       10.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Set the gaussian1 centre value to 5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Gaussian: Long Hydrogen name</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A | False |        5.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>
</pre></div>
</div>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 1.2.0: </span>Setting the <a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_function" title="hyperspy.component.Parameter.twin_function"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_inverse_function" title="hyperspy.component.Parameter.twin_inverse_function"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function</span></code></a> attributes. Set the
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_function_expr" title="hyperspy.component.Parameter.twin_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_inverse_function_expr" title="hyperspy.component.Parameter.twin_inverse_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code></a> attributes
instead.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.2.0: </span><a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_function_expr" title="hyperspy.component.Parameter.twin_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_inverse_function_expr" title="hyperspy.component.Parameter.twin_inverse_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code></a>.</p>
</div>
<p>By default the coupling function is the identity function. However it is
possible to set a different coupling function by setting the
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_function_expr" title="hyperspy.component.Parameter.twin_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.twin_inverse_function_expr" title="hyperspy.component.Parameter.twin_inverse_function_expr"><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code></a> attributes.  For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin_function_expr</span> <span class="o">=</span> <span class="s2">&quot;x**2&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin_inverse_function_expr</span> <span class="o">=</span> <span class="s2">&quot;sqrt(abs(x))&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Gaussian: Nitrogen</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True |        2.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Gaussian: Long Hydrogen name</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A | False |       16.0 |       None |        0.0 |       None</span>
<span class="go">         sigma |  True |        1.0 |       None |       None |       None</span>
<span class="go">        centre |  True |        0.0 |       None |       None |       None</span>
</pre></div>
</div>
</section>
<section id="fitting-the-model-to-the-data">
<span id="id1"></span><h2>Fitting the model to the data<a class="headerlink" href="#fitting-the-model-to-the-data" title="Permalink to this heading"></a></h2>
<p>To fit the model to the data at the current coordinates (e.g. to fit one
spectrum at a particular point in a spectrum-image), use
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.fit" title="hyperspy.model.BaseModel.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a>. HyperSpy implements a number of
different optimization approaches, each of which can have particular
benefits and/or drawbacks depending on your specific application.
A good approach to choosing an optimization approach is to ask yourself
the question “Do you want to…”:</p>
<ul class="simple">
<li><p>Apply bounds to your model parameter values?</p></li>
<li><p>Use gradient-based fitting algorithms to accelerate your fit?</p></li>
<li><p>Estimate the standard deviations of the parameter values found by the fit?</p></li>
<li><p>Fit your data in the least-squares sense, or use another loss function?</p></li>
<li><p>Find the global optima for your parameters, or is a local optima acceptable?</p></li>
</ul>
<section id="optimization-algorithms">
<h3>Optimization algorithms<a class="headerlink" href="#optimization-algorithms" title="Permalink to this heading"></a></h3>
<p>The following table summarizes the features of some of the optimizers
currently available in HyperSpy, including whether they support parameter
bounds, gradients and parameter error estimation. The “Type” column indicates
whether the optimizers find a local or global optima.</p>
<span id="optimizers-table"></span><table class="docutils align-default" id="id11">
<caption><span class="caption-text">Features of supported curve-fitting optimizers.</span><a class="headerlink" href="#id11" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 36%" />
<col style="width: 10%" />
<col style="width: 11%" />
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Optimizer</p></th>
<th class="head"><p>Bounds</p></th>
<th class="head"><p>Gradients</p></th>
<th class="head"><p>Errors</p></th>
<th class="head"><p>Loss function</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Linear</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;lm&quot;</span></code> (default)</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>local</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;trf&quot;</span></code></p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>local</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;dogbox&quot;</span></code></p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>local</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;odr&quot;</span></code></p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>local</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;lstsq&quot;</span></code></p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#id8" id="id2">1</a></p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>global</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;ridge_regression&quot;</span></code></p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#id8" id="id3">1</a></p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code></p></td>
<td><p>global</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.9.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a></p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#id9" id="id4">2</a></p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#id9" id="id5">2</a></p></td>
<td><p>No</p></td>
<td><p>All</p></td>
<td><p>local</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;Differential</span> <span class="pre">Evolution&quot;</span></code></p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>All</p></td>
<td><p>global</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;Dual</span> <span class="pre">Annealing&quot;</span></code> <a class="footnote-reference brackets" href="#id10" id="id6">3</a></p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>All</p></td>
<td><p>global</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;SHGO&quot;</span></code> <a class="footnote-reference brackets" href="#id10" id="id7">3</a></p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>All</p></td>
<td><p>global</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id8"><span class="brackets">1</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id3">2</a>)</span></dt>
<dd><p>Requires the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a> <code class="docutils literal notranslate"><span class="pre">calculate_errors</span> <span class="pre">=</span> <span class="pre">True</span></code> argument
in most cases. See the documentation below on <a class="reference internal" href="#linear-fitting-label"><span class="std std-ref">linear least square fitting</span></a>
for more info.</p>
</dd>
<dt class="label" id="id9"><span class="brackets">2</span><span class="fn-backref">(<a href="#id4">1</a>,<a href="#id5">2</a>)</span></dt>
<dd><p><strong>All</strong> of the fitting algorithms available in <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize" title="(in SciPy v1.9.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.minimize()</span></code></a> are currently
supported by HyperSpy; however, only some of them support bounds and/or gradients. For more information,
please see the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html">SciPy documentation</a>.</p>
</dd>
<dt class="label" id="id10"><span class="brackets">3</span><span class="fn-backref">(<a href="#id6">1</a>,<a href="#id7">2</a>)</span></dt>
<dd><p>Requires <code class="docutils literal notranslate"><span class="pre">scipy</span> <span class="pre">&gt;=</span> <span class="pre">1.2.0</span></code>.</p>
</dd>
</dl>
<p>The default optimizer in HyperSpy is <code class="docutils literal notranslate"><span class="pre">&quot;lm&quot;</span></code>, which stands for the <a class="reference external" href="https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm">Levenberg-Marquardt
algorithm</a>. In
earlier versions of HyperSpy (&lt; 1.6) this was known as <code class="docutils literal notranslate"><span class="pre">&quot;leastsq&quot;</span></code>.</p>
</section>
<section id="loss-functions">
<h3>Loss functions<a class="headerlink" href="#loss-functions" title="Permalink to this heading"></a></h3>
<p>HyperSpy supports a number of loss functions. The default is <code class="docutils literal notranslate"><span class="pre">&quot;ls&quot;</span></code>,
i.e. the least-squares loss. For the vast majority of cases, this loss
function is appropriate, and has the additional benefit of supporting
parameter error estimation and <a class="reference internal" href="#model-goodness-of-fit"><span class="std std-ref">goodness-of-fit</span></a>
testing. However, if your data contains very low counts per pixel, or
is corrupted by outliers, the <code class="docutils literal notranslate"><span class="pre">&quot;ML-poisson&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;huber&quot;</span></code> loss
functions may be worth investigating.</p>
<section id="least-squares-with-error-estimation">
<h4>Least squares with error estimation<a class="headerlink" href="#least-squares-with-error-estimation" title="Permalink to this heading"></a></h4>
<p>The following example shows how to perfom least squares optimization with
error estimation. First we create data consisting of a line
<code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">a*x</span> <span class="pre">+</span> <span class="pre">b</span></code> with <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">=</span> <span class="pre">100</span></code>, and we then add Gaussian
noise to it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">add_gaussian_noise</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>To fit it, we create a model consisting of a
<a class="reference internal" href="../api/hyperspy._components.polynomial.html#hyperspy._components.polynomial.Polynomial" title="hyperspy._components.polynomial.Polynomial"><code class="xref py py-class docutils literal notranslate"><span class="pre">Polynomial</span></code></a> component of order 1 and fit it
to the data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>Once the fit is complete, the optimized value of the parameters and their
estimated standard deviation are stored in the following line attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">value</span>
<span class="go">0.9924615648843765</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
<span class="go">103.67507406125888</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">std</span>
<span class="go">0.11771053738516088</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">std</span>
<span class="go">13.541061301257537</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When the noise is heteroscedastic, only if the
<code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code> attribute of the
<a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D" title="hyperspy._signals.signal1d.Signal1D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code></a> instance is defined can
the parameter standard deviations be estimated accurately.</p>
<p>If the variance is not defined, the standard deviations are still
computed, by setting variance equal to 1. However, this calculation
will not be correct unless an accurate value of the variance is
provided. See <a class="reference internal" href="signal.html#signal-noise-properties"><span class="std std-ref">Setting the noise properties</span></a> for more information.</p>
</div>
</section>
<section id="weighted-least-squares-with-error-estimation">
<span id="weighted-least-squares-label"></span><h4>Weighted least squares with error estimation<a class="headerlink" href="#weighted-least-squares-with-error-estimation" title="Permalink to this heading"></a></h4>
<p>In the following example, we add Poisson noise to the data instead of
Gaussian noise, and proceed to fit as in the previous example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">add_poissonian_noise</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span>  <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0052331707848698, -1.0723588390873573)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">std</span>
<span class="go">(0.0081710549764721901, 1.4117294994070277)</span>
</pre></div>
</div>
<p>Because the noise is heteroscedastic, the least squares optimizer estimation is
biased. A more accurate result can be obtained with weighted least squares,
where the weights are proportional to the inverse of the noise variance.
Although this is still biased for Poisson noise, it is a good approximation
in most cases where there are a sufficient number of counts per pixel.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp_val</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">estimate_poissonian_noise_variance</span><span class="p">(</span><span class="n">expected_value</span><span class="o">=</span><span class="n">exp_val</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0004224896604759, -0.46982916592391377)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">std</span>
<span class="go">(0.0055752036447948173, 0.46950832982673557)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When the attribute <code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code>
is defined, the behaviour is to perform a weighted least-squares
fit using the inverse of the noise variance as the weights.
In this scenario, to then disable weighting, you will need to <strong>unset</strong>
the attribute. You can achieve this with
<a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.BaseSignal.set_noise_variance" title="hyperspy.signal.BaseSignal.set_noise_variance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_noise_variance()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">set_noise_variance</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># This will now be an unweighted fit</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0052331707848698, -1.0723588390873573)</span>
</pre></div>
</div>
</div>
</section>
<section id="poisson-maximum-likelihood-estimation">
<h4>Poisson maximum likelihood estimation<a class="headerlink" href="#poisson-maximum-likelihood-estimation" title="Permalink to this heading"></a></h4>
<p>To avoid biased estimation in the case of data corrupted by Poisson noise
with very few counts, we can use Poisson maximum likelihood estimation (MLE) instead.
This is an unbiased estimator for Poisson noise. To perform MLE, we must
use a general, non-linear optimizer from the <a class="reference internal" href="#optimizers-table"><span class="std std-ref">table above</span></a>,
such as Nelder-Mead or L-BFGS-B:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="s2">&quot;ML-poisson&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0030718094185611, -0.63590210946134107)</span>
</pre></div>
</div>
<p>Estimation of the parameter errors is not currently supported for Poisson
maximum likelihood estimation.</p>
</section>
<section id="huber-loss-function">
<h4>Huber loss function<a class="headerlink" href="#huber-loss-function" title="Permalink to this heading"></a></h4>
<p>HyperSpy also implements the
<a class="reference external" href="https://en.wikipedia.org/wiki/Huber_loss">Huber loss</a> function,
which is typically less sensitive to outliers in the data compared
to the least-squares loss. Again, we need to use one of the general
non-linear optimization algorithms:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="s2">&quot;huber&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Estimation of the parameter errors is not currently supported
for the Huber loss function.</p>
</section>
<section id="custom-loss-functions">
<h4>Custom loss functions<a class="headerlink" href="#custom-loss-functions" title="Permalink to this heading"></a></h4>
<p>As well as the built-in loss functions described above,
a custom loss function can be passed to the model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_custom_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="gp">... </span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">   Parameters</span>
<span class="gp">... </span><span class="sd">   ----------</span>
<span class="gp">... </span><span class="sd">   model : Model instance</span>
<span class="gp">... </span><span class="sd">       the model that is fitted.</span>
<span class="gp">... </span><span class="sd">   values : np.ndarray</span>
<span class="gp">... </span><span class="sd">       A one-dimensional array with free parameter values suggested by the</span>
<span class="gp">... </span><span class="sd">       optimizer (that are not yet stored in the model).</span>
<span class="gp">... </span><span class="sd">   data : np.ndarray</span>
<span class="gp">... </span><span class="sd">       A one-dimensional array with current data that is being fitted.</span>
<span class="gp">... </span><span class="sd">   weights : {np.ndarray, None}</span>
<span class="gp">... </span><span class="sd">       An optional one-dimensional array with parameter weights.</span>
<span class="gp">...</span><span class="sd"></span>
<span class="gp">... </span><span class="sd">   Returns</span>
<span class="gp">... </span><span class="sd">   -------</span>
<span class="gp">... </span><span class="sd">   score : float</span>
<span class="gp">... </span><span class="sd">       A signle float value, representing a score of the fit, with</span>
<span class="gp">... </span><span class="sd">       lower values corresponding to better fits.</span>
<span class="gp">... </span><span class="sd">   &quot;&quot;&quot;</span>
<span class="gp">... </span>   <span class="c1"># Almost any operation can be performed, for example:</span>
<span class="gp">... </span>   <span class="c1"># First we store the suggested values in the model</span>
<span class="gp">... </span>   <span class="n">model</span><span class="o">.</span><span class="n">fetch_values_from_array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="c1"># Evaluate the current model</span>
<span class="gp">... </span>   <span class="n">cur_value</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">onlyactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="c1"># Calculate the weighted difference with data</span>
<span class="gp">... </span>   <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="gp">... </span>       <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">... </span>   <span class="n">difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">cur_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">weights</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="c1"># Return squared and summed weighted difference</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="p">(</span><span class="n">difference</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># We must use a general non-linear optimizer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="n">my_custom_function</span><span class="p">)</span>
</pre></div>
</div>
<p>If the optimizer requires an analytical gradient function, it can be similarly
passed, using the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_custom_gradient_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="gp">... </span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">   Parameters</span>
<span class="gp">... </span><span class="sd">   ----------</span>
<span class="gp">... </span><span class="sd">   model : Model instance</span>
<span class="gp">... </span><span class="sd">       the model that is fitted.</span>
<span class="gp">... </span><span class="sd">   values : np.ndarray</span>
<span class="gp">... </span><span class="sd">       A one-dimensional array with free parameter values suggested by the</span>
<span class="gp">... </span><span class="sd">       optimizer (that are not yet stored in the model).</span>
<span class="gp">... </span><span class="sd">   data : np.ndarray</span>
<span class="gp">... </span><span class="sd">       A one-dimensional array with current data that is being fitted.</span>
<span class="gp">... </span><span class="sd">   weights : {np.ndarray, None}</span>
<span class="gp">... </span><span class="sd">       An optional one-dimensional array with parameter weights.</span>
<span class="gp">...</span><span class="sd"></span>
<span class="gp">... </span><span class="sd">   Returns</span>
<span class="gp">... </span><span class="sd">   -------</span>
<span class="gp">... </span><span class="sd">   gradients : np.ndarray</span>
<span class="gp">... </span><span class="sd">       a one-dimensional array of gradients, the size of `values`,</span>
<span class="gp">... </span><span class="sd">       containing each parameter gradient with the given values</span>
<span class="gp">... </span><span class="sd">   &quot;&quot;&quot;</span>
<span class="gp">... </span>   <span class="c1"># As an example, estimate maximum likelihood gradient:</span>
<span class="gp">... </span>   <span class="n">model</span><span class="o">.</span><span class="n">fetch_values_from_array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="gp">... </span>   <span class="n">cur_value</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">onlyactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="c1"># We use in-built jacobian estimation</span>
<span class="gp">... </span>   <span class="n">jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">jac</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="n">cur_value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># We must use a general non-linear optimizer again</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
<span class="gp">... </span>      <span class="n">loss_function</span><span class="o">=</span><span class="n">my_custom_function</span><span class="p">,</span>
<span class="gp">... </span>      <span class="n">grad</span><span class="o">=</span><span class="n">my_custom_gradient_function</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="using-gradient-information">
<h3>Using gradient information<a class="headerlink" href="#using-gradient-information" title="Permalink to this heading"></a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.6: </span><code class="docutils literal notranslate"><span class="pre">grad=&quot;analytical&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">grad=&quot;fd&quot;</span></code> keyword arguments</p>
</div>
<p>Optimization algorithms that take into account the gradient of
the loss function will often out-perform so-called “derivative-free”
optimization algorithms in terms of how rapidly they converge to a
solution. HyperSpy can use analytical gradients for model-fitting,
as well as numerical estimates of the gradient based on finite differences.</p>
<p>If all the components in the model support analytical gradients,
you can pass <code class="docutils literal notranslate"><span class="pre">grad=&quot;analytical&quot;</span></code> in order to use this information
when fitting. The results are typically more accurate than an
estimated gradient, and the optimization often runs faster since
fewer function evaluations are required to calculate the gradient.</p>
<p>Following the above examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Use a 2-point finite-difference scheme to estimate the gradient</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">fd_scheme</span><span class="o">=</span><span class="s2">&quot;2-point&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Use the analytical gradient</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="s2">&quot;analytical&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Huber loss and Poisson MLE functions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># also support analytical gradients</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="s2">&quot;analytical&quot;</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="s2">&quot;huber&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="s2">&quot;analytical&quot;</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="s2">&quot;ML-poisson&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Analytical gradients are not yet implemented for the
<a class="reference internal" href="../api/hyperspy.models.model2d.html#hyperspy.models.model2d.Model2D" title="hyperspy.models.model2d.Model2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model2D</span></code></a> class.</p>
</div>
</section>
<section id="bounded-optimization">
<h3>Bounded optimization<a class="headerlink" href="#bounded-optimization" title="Permalink to this heading"></a></h3>
<p>Non-linear optimization can sometimes fail to converge to a good optimum,
especially if poor starting values are provided. Problems of ill-conditioning
and non-convergence can be improved by using bounded optimization.</p>
<p>All components’ parameters have the attributes <code class="docutils literal notranslate"><span class="pre">parameter.bmin</span></code> and
<code class="docutils literal notranslate"><span class="pre">parameter.bmax</span></code> (“bounded min” and “bounded max”). When fitting using the
<code class="docutils literal notranslate"><span class="pre">bounded=True</span></code> argument by <code class="docutils literal notranslate"><span class="pre">m.fit(bounded=True)</span></code> or <code class="docutils literal notranslate"><span class="pre">m.multifit(bounded=True)</span></code>,
these attributes set the minimum and maximum values allowed for <code class="docutils literal notranslate"><span class="pre">parameter.value</span></code>.</p>
<p>Currently, not all optimizers support bounds - see the
<a class="reference internal" href="#optimizers-table"><span class="std std-ref">table above</span></a>. In the following example, a Gaussian
histogram is fitted using a <a class="reference internal" href="../api/hyperspy._components.gaussian.html#hyperspy._components.gaussian.Gaussian" title="hyperspy._components.gaussian.Gaussian"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code></a>
component using the Levenberg-Marquardt (“lm”) optimizer and bounds
on the <code class="docutils literal notranslate"><span class="pre">centre</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">BaseSignal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span><span class="n">size</span><span class="o">=</span><span class="mi">100000</span><span class="p">))</span><span class="o">.</span><span class="n">get_histogram</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">axes_manager</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_binned</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="mi">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">bmax</span> <span class="o">=</span> <span class="mi">14</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lm&quot;</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">(</span><span class="n">fancy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">Model1D:  histogram</span>
<span class="go">Gaussian: Gaussian</span>
<span class="go">Active: True</span>
<span class="go">Parameter Name |  Free |      Value |        Std |        Min |        Max</span>
<span class="go">============== | ===== | ========== | ========== | ========== | ==========</span>
<span class="go">             A |  True | 99997.3481 | 232.333693 |        0.0 |       None</span>
<span class="go">         sigma |  True | 0.00999184 | 2.68064163 |       None |       None</span>
<span class="go">        centre |  True | 9.99980788 | 2.68064070 |        7.0 |       14.0</span>
</pre></div>
</div>
</section>
<section id="linear-least-squares">
<span id="linear-fitting-label"></span><h3>Linear least squares<a class="headerlink" href="#linear-least-squares" title="Permalink to this heading"></a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.7.</span></p>
</div>
<p>Linear fitting can be used to address some of the drawbacks of non-linear optimization:</p>
<ul class="simple">
<li><p>it doesn’t suffer from the <em>starting parameters</em> issue, which can sometimes be problematic
with nonlinear fitting. Since linear fitting uses linear algebra to find the
solution (find the parameter values of the model), the solution is a unique solution,
while nonlinear optimization uses an iterative approach and therefore relies
on the initial values of the parameters.</p></li>
<li><p>it is fast, because i) in favorable situations, the signal can be fitted in a vectorized
fashion, i.e. the signal is fitted in a single run instead of iterating over
the navigation dimension; ii) it is not iterative, <cite>i.e.</cite> it does the
calculation only one time instead of 10-100 iterations, depending on how
quickly the non-linear optimizer will converge.</p></li>
</ul>
<p>However, linear fitting can <em>only</em> fit linear models and will not be able to fit
parameters which vary <em>non-linearly</em>.</p>
<p>A component is considered linear when its free parameters scale the component only
in the y-axis. For the exemplary function <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">a*x**b</span></code>, <code class="docutils literal notranslate"><span class="pre">a</span></code> is a linear parameter, whilst <code class="docutils literal notranslate"><span class="pre">b</span></code>
is not. If <code class="docutils literal notranslate"><span class="pre">b.free</span> <span class="pre">=</span> <span class="pre">False</span></code>, then the component is linear.
Components can also be made up of several linear parts. For instance,
the 2D-polynomial <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">a*x**2+b*y**2+c*x+d*y+e</span></code> is entirely linear.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After creating a model with values for the nonlinear parameters, a quick way to set
all nonlinear parameters to be <code class="docutils literal notranslate"><span class="pre">free</span> <span class="pre">=</span> <span class="pre">False</span></code> is to use <code class="docutils literal notranslate"><span class="pre">m.set_parameters_not_free(only_nonlinear=True)</span></code></p>
</div>
<p>To check if a parameter is linear, use the model or component method
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.print_current_values" title="hyperspy.model.BaseModel.print_current_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">print_current_values()</span></code></a>. For a component to be
considered linear, it can hold only one free parameter, and that parameter
must be linear.</p>
<p>If all components in a model are linear, then a linear optimizer can be used to
solve the problem as a linear regression problem! This can be done using two approaches:</p>
<ul class="simple">
<li><p>the standard pixel-by-pixel approach as used by the <em>nonlinear</em> optimizers</p></li>
<li><p>fit the entire dataset in one <em>vectorised</em> operation, which will be much faster (up to 1000 times).
However, there is a caveat: all fixed parameters must have the same value across the dataset in
order to avoid creating a very large array whose size will scale with the number of different
values of the non-free parameters.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A good example of a linear model in the electron-microscopy field is an Energy-Dispersive
X-ray Spectroscopy (EDS) dataset, which typically consists of a polynomial background and
Gaussian peaks with well-defined energy (<code class="docutils literal notranslate"><span class="pre">Gaussian.centre</span></code>) and peak widths
(<code class="docutils literal notranslate"><span class="pre">Gaussian.sigma</span></code>). This dataset can be fit extremely fast with a linear optimizer.</p>
</div>
<p>There are two implementations of linear least squares fitting in hyperspy:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">'lstsq'</span></code> optimizer, which uses <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.lstsq.html#numpy.linalg.lstsq" title="(in NumPy v1.23)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.linalg.lstsq()</span></code></a>, or
<a class="reference external" href="https://docs.dask.org/en/latest/generated/dask.array.linalg.lstsq.html#dask.array.linalg.lstsq" title="(in Dask)"><code class="xref py py-func docutils literal notranslate"><span class="pre">dask.array.linalg.lstsq()</span></code></a> for lazy signals.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">'ridge_regression'</span></code> optimizer, which supports regularization
(see <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Ridge.html#sklearn.linear_model.Ridge" title="(in scikit-learn v1.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.linear_model.Ridge</span></code></a> for arguments to pass to
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.fit" title="hyperspy.model.BaseModel.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a>), but does not support lazy signals.</p></li>
</ul>
<p>As for non-linear least squares fitting, <a class="reference internal" href="#weighted-least-squares-label"><span class="std std-ref">weighted least squares</span></a>
is supported.</p>
<p>In the following example, we first generate a 300x300 navigation signal of varying total intensity,
and then populate it with an EDS spectrum at each point. The signal can be fitted with a polynomial
background and a Gaussian for each peak. Hyperspy automatically adds these to the model, and fixes
the <code class="docutils literal notranslate"><span class="pre">centre</span></code> and <code class="docutils literal notranslate"><span class="pre">sigma</span></code> parameters to known values. Fitting this model with a non-linear optimizer
can about half an hour on a decent workstation. With a linear optimizer, it takes seconds.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nav</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">example_signals</span><span class="o">.</span><span class="n">EDS_SEM_Spectrum</span><span class="p">()</span> <span class="o">*</span> <span class="n">nav</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">multifit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Standard errors for the parameters are by default not calculated when the dataset
is fitted in vectorized fashion, because it has large memory requirement.
If errors are required, either pass <code class="docutils literal notranslate"><span class="pre">calculate_errors=True</span></code> as an argument
to <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a>, or rerun
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a> with a nonlinear optimizer,
which should run fast since the parameters are already optimized.</p>
<p>None of the linear optimizers currently support bounds.</p>
</section>
<section id="optimization-results">
<h3>Optimization results<a class="headerlink" href="#optimization-results" title="Permalink to this heading"></a></h3>
<p>After fitting the model, details about the optimization
procedure, including whether it finished successfully,
are returned as <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html#scipy.optimize.OptimizeResult" title="(in SciPy v1.9.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.optimize.OptimizeResult</span></code></a> object,
according to the keyword argument <code class="docutils literal notranslate"><span class="pre">return_info=True</span></code>.
These details are often useful for diagnosing problems such
as a poorly-fitted model or a convergence failure.
You can also access the object as the <code class="docutils literal notranslate"><span class="pre">fit_output</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="go">&lt;scipy.optimize.OptimizeResult object&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">fit_output</span><span class="p">)</span>
<span class="go">&lt;scipy.optimize.OptimizeResult object&gt;</span>
</pre></div>
</div>
<p>You can also print this information using the
<code class="docutils literal notranslate"><span class="pre">print_info</span></code> keyword argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the info to stdout</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">print_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Fit</span> <span class="n">info</span><span class="p">:</span>
  <span class="n">optimizer</span><span class="o">=</span><span class="n">L</span><span class="o">-</span><span class="n">BFGS</span><span class="o">-</span><span class="n">B</span>
  <span class="n">loss_function</span><span class="o">=</span><span class="n">ls</span>
  <span class="n">bounded</span><span class="o">=</span><span class="kc">False</span>
  <span class="n">grad</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span>
<span class="n">Fit</span> <span class="n">result</span><span class="p">:</span>
  <span class="n">hess_inv</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">3</span><span class="n">x3</span> <span class="n">LbfgsInvHessProduct</span> <span class="k">with</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="o">&gt;</span>
   <span class="n">message</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&#39;</span>
      <span class="n">nfev</span><span class="p">:</span> <span class="mi">168</span>
       <span class="n">nit</span><span class="p">:</span> <span class="mi">32</span>
      <span class="n">njev</span><span class="p">:</span> <span class="mi">42</span>
    <span class="n">status</span><span class="p">:</span> <span class="mi">0</span>
   <span class="n">success</span><span class="p">:</span> <span class="kc">True</span>
         <span class="n">x</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">9.97614503e+03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.10610734e-01</span><span class="p">,</span>  <span class="mf">1.98380701e+00</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="goodness-of-fit">
<span id="model-goodness-of-fit"></span><h3>Goodness of fit<a class="headerlink" href="#goodness-of-fit" title="Permalink to this heading"></a></h3>
<p>The chi-squared, reduced chi-squared and the degrees of freedom are
computed automatically when fitting a (weighted) least-squares model
(i.e. only when <code class="docutils literal notranslate"><span class="pre">loss_function=&quot;ls&quot;</span></code>). They are stored as signals, in the
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.chisq" title="hyperspy.model.BaseModel.chisq"><code class="xref py py-attr docutils literal notranslate"><span class="pre">chisq</span></code></a>, <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.red_chisq" title="hyperspy.model.BaseModel.red_chisq"><code class="xref py py-attr docutils literal notranslate"><span class="pre">red_chisq</span></code></a> and
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.dof" title="hyperspy.model.BaseModel.dof"><code class="xref py py-attr docutils literal notranslate"><span class="pre">dof</span></code></a> attributes of the model respectively.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Unless <code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code> contains
an accurate estimation of the variance of the data, the chi-squared and
reduced chi-squared will not be computed correctly. This is true for both
homocedastic and heteroscedastic noise.</p>
</div>
</section>
<section id="visualizing-the-model">
<span id="model-visualization"></span><h3>Visualizing the model<a class="headerlink" href="#visualizing-the-model" title="Permalink to this heading"></a></h3>
<p>To visualise the result use the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.plot" title="hyperspy.model.BaseModel.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># Visualise the results</span>
</pre></div>
</div>
<p>By default only the full model line is displayed in the plot. In addition, it
is possible to display the individual components by calling
<code class="xref py py-meth docutils literal notranslate"><span class="pre">enable_plot_components()</span></code> or directly using
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.plot" title="hyperspy.model.BaseModel.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_components</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Visualise the results</span>
</pre></div>
</div>
<p>To disable this feature call
<code class="xref py py-meth docutils literal notranslate"><span class="pre">disable_plot_components()</span></code>.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4: </span><code class="docutils literal notranslate"><span class="pre">Signal1D.plot</span></code> keyword arguments</p>
</div>
<p>All extra keyword argments are passes to the <code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code> method of the
corresponing signal object. For example, the following plots the model signal
figure but not its navigator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">navigator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>By default the model plot is automatically updated when any parameter value
changes. It is possible to suspend this feature with
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.suspend_update" title="hyperspy.model.BaseModel.suspend_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">suspend_update()</span></code></a>.</p>
</section>
<section id="setting-the-initial-parameters">
<span id="model-starting"></span><h3>Setting the initial parameters<a class="headerlink" href="#setting-the-initial-parameters" title="Permalink to this heading"></a></h3>
<p>Non-linear optimization often requires setting sensible starting parameters.
This can be done by plotting the model and adjusting the parameters by hand.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.3: </span>All <code class="xref py py-meth docutils literal notranslate"><span class="pre">notebook_interaction()</span></code> methods renamed to <code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code>. The
<code class="xref py py-meth docutils literal notranslate"><span class="pre">notebook_interaction()</span></code> methods will be removed in 2.0</p>
</div>
<p id="notebook-interaction-label">If running in a Jupyter Notebook, interactive widgets can be used to
conveniently adjust the parameter values by running
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.gui" title="hyperspy.model.BaseModel.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a> for <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a>,
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component" title="hyperspy.component.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter" title="hyperspy.component.Parameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code></a>.</p>
<figure class="align-center" id="id12">
<a class="reference internal image-reference" href="../_images/notebook_widgets.png"><img alt="../_images/notebook_widgets.png" src="../_images/notebook_widgets.png" style="width: 985px;" /></a>
<figcaption>
<p><span class="caption-text">Interactive widgets for the full model in a Jupyter notebook. Drag the
sliders to adjust current parameter values. Typing different minimum and
maximum values changes the boundaries of the slider.</span><a class="headerlink" href="#id12" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Also, <a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D.enable_adjust_position" title="hyperspy.models.model1d.Model1D.enable_adjust_position"><code class="xref py py-meth docutils literal notranslate"><span class="pre">enable_adjust_position()</span></code></a> provides an
interactive way of setting the position of the components with a
well-defined position.
<a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D.disable_adjust_position" title="hyperspy.models.model1d.Model1D.disable_adjust_position"><code class="xref py py-meth docutils literal notranslate"><span class="pre">disable_adjust_position()</span></code></a> disables the tool.</p>
<figure class="align-center" id="id13">
<a class="reference internal image-reference" href="../_images/model_adjust_position.png"><img alt="../_images/model_adjust_position.png" src="../_images/model_adjust_position.png" style="width: 500px;" /></a>
<figcaption>
<p><span class="caption-text">Interactive component position adjustment tool. Drag the vertical lines
to set the initial value of the position parameter.</span><a class="headerlink" href="#id13" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="exclude-data-from-the-fitting-process">
<h3>Exclude data from the fitting process<a class="headerlink" href="#exclude-data-from-the-fitting-process" title="Permalink to this heading"></a></h3>
<p>The following <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a> methods can be used to exclude
undesired spectral channels from the fitting process:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D.set_signal_range" title="hyperspy.models.model1d.Model1D.set_signal_range"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_signal_range()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D.remove_signal_range" title="hyperspy.models.model1d.Model1D.remove_signal_range"><code class="xref py py-meth docutils literal notranslate"><span class="pre">remove_signal_range()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy.models.model1d.html#hyperspy.models.model1d.Model1D.reset_signal_range" title="hyperspy.models.model1d.Model1D.reset_signal_range"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reset_signal_range()</span></code></a></p></li>
</ul>
<p>In 2D models, those methods are not implemented and the
<code class="docutils literal notranslate"><span class="pre">m.channel_switches</span></code> attribute of a model can be set using boolean arrays of the
same shape as the data’s signal, where <code class="docutils literal notranslate"><span class="pre">True</span></code> means that the datapoint
will be used in the fitting routine.</p>
<p>The example below shows how a boolean array can be easily created from the
signal and how the <code class="docutils literal notranslate"><span class="pre">isig</span></code> syntax can be used to define the signal range.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a sample 2D gaussian dataset</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components2D</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">(</span>
<span class="gp">... </span>  <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">centre_x</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">centre_y</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sigma_y</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">axes_manager</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">axes_manager</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">axes_manager</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">axes_manager</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span> <span class="c1"># Model initialisation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components2D</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a boolean signal of the same shape as the signal space of im</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># and with all values set to `False`.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">signal_mask</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">im</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Specify the signal range using the isig syntax</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">signal_mask</span><span class="o">.</span><span class="n">isig</span><span class="p">[</span><span class="o">-</span><span class="mf">7.</span><span class="p">:</span><span class="o">-</span><span class="mf">3.</span><span class="p">,</span><span class="o">-</span><span class="mf">9.</span><span class="p">:</span><span class="o">-</span><span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">channel_switches</span> <span class="o">=</span> <span class="n">signal_mask</span><span class="o">.</span><span class="n">data</span> <span class="c1"># Set channel switches</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="fitting-multidimensional-datasets">
<span id="model-multidimensional-label"></span><h3>Fitting multidimensional datasets<a class="headerlink" href="#fitting-multidimensional-datasets" title="Permalink to this heading"></a></h3>
<p>To fit the model to all the elements of a multidimensional dataset, use
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">multifit</span><span class="p">()</span> <span class="c1"># warning: this can be a lengthy process on large datasets</span>
</pre></div>
</div>
<p><a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a> fits the model at the first position,
stores the result of the fit internally and move to the next position until
reaching the end of the dataset.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes this method can fail, especially in the case of a TEM spectrum
image of a particle surrounded by vacuum (since in that case the
top-left pixel will typically be an empty signal).</p>
<p>To get sensible starting parameters, you can do a single
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.fit" title="hyperspy.model.BaseModel.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a> after changing the active position
within the spectrum image (either using the plotting GUI or by directly
modifying <code class="docutils literal notranslate"><span class="pre">s.axes_manager.indices</span></code> as in <a class="reference internal" href="axes.html#setting-axis-properties"><span class="std std-ref">Setting axis properties</span></a>).</p>
<p>After doing this, you can initialize the model at every pixel to the
values from the single pixel fit using <code class="docutils literal notranslate"><span class="pre">m.assign_current_values_to_all()</span></code>,
and then use <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a> to perform the fit over
the entire spectrum image.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.6: </span>New optional fitting iteration path <cite>“serpentine”</cite></p>
</div>
<p>Typically, curve fitting on a multidimensional dataset happens in the following
manner: Pixels are fit along the row from the first index in the first row, and once the
last pixel in the row is reached, one proceeds from the first index in the second row.
Since the fitting procedure typically uses the fit of the previous pixel
as the starting point for the next, a common problem with this fitting iteration
path is that the fitting fails going from the end of one row to the beginning of
the next, as the spectrum can change abruptly. This kind of iteration path is
the default in HyperSpy (but will change to <code class="docutils literal notranslate"><span class="pre">'serpentine'</span></code> in HyperSpy version
2.0). It can be explicitly set using the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a>
<code class="docutils literal notranslate"><span class="pre">iterpath='flyback'</span></code> argument.</p>
<p>A simple solution to the flyback fitting problem is to iterate through the
signal indices in a horizontal serpentine pattern, as seen on the image below.
This alternate iteration method can be enabled by the <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a>
<code class="docutils literal notranslate"><span class="pre">iterpath='serpentine'</span></code> argument. The serpentine pattern supports n-dimensional
navigation space, so the first index in the second frame of a three-dimensional
navigation space will be at the last position of the previous frame.</p>
<figure class="align-center" id="id14">
<a class="reference internal image-reference" href="../_images/FlybackVsSerpentine.png"><img alt="../_images/FlybackVsSerpentine.png" src="../_images/FlybackVsSerpentine.png" style="width: 500px;" /></a>
<figcaption>
<p><span class="caption-text">Comparing the scan patterns generated by the  <code class="docutils literal notranslate"><span class="pre">'flyback'</span></code> and <code class="docutils literal notranslate"><span class="pre">'serpentine'</span></code>
iterpath options for a 2D navigation space. The pixel intensity and number refers
to the order that the signal is fitted in.</span><a class="headerlink" href="#id14" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">'serpentine'</span></code> and <code class="docutils literal notranslate"><span class="pre">'flyback'</span></code>, <code class="docutils literal notranslate"><span class="pre">iterpath</span></code> can take as argument any list
or array of indices, or a generator of such, as explained in the <a class="reference internal" href="axes.html#iterating-axesmanager"><span class="std std-ref">Iterating AxesManager</span></a> section.</p>
<p>Sometimes one may like to store and fetch the value of the parameters at a
given position manually. This is possible using
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.store_current_values" title="hyperspy.model.BaseModel.store_current_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">store_current_values()</span></code></a> and
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.fetch_stored_values" title="hyperspy.model.BaseModel.fetch_stored_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fetch_stored_values()</span></code></a>.</p>
</section>
<section id="visualising-the-result-of-the-fit">
<h3>Visualising the result of the fit<a class="headerlink" href="#visualising-the-result-of-the-fit" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a> <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.plot_results" title="hyperspy.model.BaseModel.plot_results"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot_results()</span></code></a>,
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component" title="hyperspy.component.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code></a> <a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.plot" title="hyperspy.component.Component.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter" title="hyperspy.component.Parameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code></a> <a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.plot" title="hyperspy.component.Parameter.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a> methods
can be used to visualise the result of the fit <strong>when fitting multidimensional
datasets</strong>.</p>
</section>
</section>
<section id="storing-models">
<span id="storing-models-label"></span><h2>Storing models<a class="headerlink" href="#storing-models" title="Permalink to this heading"></a></h2>
<p>Multiple models can be stored in the same signal. In particular, when
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.store" title="hyperspy.model.BaseModel.store"><code class="xref py py-meth docutils literal notranslate"><span class="pre">store()</span></code></a> is called, a full “frozen” copy of the model
is stored in stored in the signal’s <a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.ModelManager" title="hyperspy.signal.ModelManager"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelManager</span></code></a>,
which can be accessed in the <code class="docutils literal notranslate"><span class="pre">models</span></code> attribute (i.e. <code class="docutils literal notranslate"><span class="pre">s.models</span></code>)
The stored models can be recreated at any time by calling
<a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.ModelManager.restore" title="hyperspy.signal.ModelManager.restore"><code class="xref py py-meth docutils literal notranslate"><span class="pre">restore()</span></code></a> with the stored
model name as an argument. To remove a model from storage, simply call
<a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.ModelManager.remove" title="hyperspy.signal.ModelManager.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">remove()</span></code></a>.</p>
<p>The stored models can be either given a name, or assigned one automatically.
The automatic naming follows alphabetical scheme, with the sequence being (a,
b, …, z, aa, ab, …, az, ba, …).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to slice a model, you have to perform the operation on the
model itself, not its stored version</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Modifying a signal in-place (e.g. <a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.BaseSignal.map" title="hyperspy.signal.BaseSignal.map"><code class="xref py py-meth docutils literal notranslate"><span class="pre">map()</span></code></a>,
<a class="reference internal" href="../api/hyperspy.signal.html#hyperspy.signal.BaseSignal.crop" title="hyperspy.signal.BaseSignal.crop"><code class="xref py py-meth docutils literal notranslate"><span class="pre">crop()</span></code></a>,
<a class="reference internal" href="../api/hyperspy._signals.signal1d.html#hyperspy._signals.signal1d.Signal1D.align1D" title="hyperspy._signals.signal1d.Signal1D.align1D"><code class="xref py py-meth docutils literal notranslate"><span class="pre">align1D()</span></code></a>,
<a class="reference internal" href="../api/hyperspy._signals.signal2d.html#hyperspy._signals.signal2d.Signal2D.align2D" title="hyperspy._signals.signal2d.Signal2D.align2D"><code class="xref py py-meth docutils literal notranslate"><span class="pre">align2D()</span></code></a> and similar)
will invalidate all stored models. This is done intentionally.</p>
</div>
<p>Current stored models can be listed by calling <code class="docutils literal notranslate"><span class="pre">s.models</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Lorentzian</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s1">&#39;myname&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">models</span>
<span class="go">└── myname</span>
<span class="go">    ├── components</span>
<span class="go">    │   └── Lorentzian</span>
<span class="go">    ├── date = 2015-09-07 12:01:50</span>
<span class="go">    └── dimensions = (|100)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Exponential</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="c1"># assign model name automatically</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">models</span>
<span class="go">├── a</span>
<span class="go">│   ├── components</span>
<span class="go">│   │   ├── Exponential</span>
<span class="go">│   │   └── Lorentzian</span>
<span class="go">│   ├── date = 2015-09-07 12:01:57</span>
<span class="go">│   └── dimensions = (|100)</span>
<span class="go">└── myname</span>
<span class="go">    ├── components</span>
<span class="go">    │   └── Lorentzian</span>
<span class="go">    ├── date = 2015-09-07 12:01:50</span>
<span class="go">    └── dimensions = (|100)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;myname&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |      Attribute Name |       Component Name |       Component Type</span>
<span class="go">---- | ------------------- | -------------------- | --------------------</span>
<span class="go">   0 |          Lorentzian |           Lorentzian |           Lorentzian</span>
</pre></div>
</div>
<section id="saving-and-loading-the-result-of-the-fit">
<h3>Saving and loading the result of the fit<a class="headerlink" href="#saving-and-loading-the-result-of-the-fit" title="Permalink to this heading"></a></h3>
<p>To save a model, a convenience function <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.save" title="hyperspy.model.BaseModel.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> is
provided, which stores the current model into its signal and saves the
signal. As described in <a class="reference internal" href="#storing-models-label"><span class="std std-ref">Storing models</span></a>, more than just one
model can be saved with one signal.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># analysis and fitting goes here</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;my_filename&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;my_filename.hspy&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="c1"># or l.models.model_name.restore()</span>
</pre></div>
</div>
<p>For older versions of HyperSpy (before 0.9), the instructions were as follows:</p>
<blockquote>
<div><p>Note that this method is known to be brittle i.e. there is no
guarantee that a version of HyperSpy different from the one used to save
the model will be able to load it successfully.  Also, it is
advisable not to use this method in combination with functions that
alter the value of the parameters interactively (e.g.
<cite>enable_adjust_position</cite>) as the modifications made by this functions
are normally not stored in the IPython notebook or Python script.</p>
<p>To save a model:</p>
<ol class="arabic simple">
<li><p>Save the parameter arrays to a file using
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.save_parameters2file" title="hyperspy.model.BaseModel.save_parameters2file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save_parameters2file()</span></code></a>.</p></li>
<li><p>Save all the commands that used to create the model to a file. This
can be done in the form of an IPython notebook or a Python script.</p></li>
<li><p>(Optional) Comment out or delete the fitting commands (e.g.
<a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.multifit" title="hyperspy.model.BaseModel.multifit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code></a>).</p></li>
</ol>
<p>To recreate the model:</p>
<ol class="arabic simple">
<li><p>Execute the IPython notebook or Python script.</p></li>
<li><p>Use <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.load_parameters_from_file" title="hyperspy.model.BaseModel.load_parameters_from_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">load_parameters_from_file()</span></code></a> to load
back the parameter values and arrays.</p></li>
</ol>
</div></blockquote>
</section>
<section id="exporting-the-result-of-the-fit">
<h3>Exporting the result of the fit<a class="headerlink" href="#exporting-the-result-of-the-fit" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel" title="hyperspy.model.BaseModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code></a> <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.export_results" title="hyperspy.model.BaseModel.export_results"><code class="xref py py-meth docutils literal notranslate"><span class="pre">export_results()</span></code></a>,
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component" title="hyperspy.component.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code></a> <a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Component.export" title="hyperspy.component.Component.export"><code class="xref py py-meth docutils literal notranslate"><span class="pre">export()</span></code></a> and
<a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter" title="hyperspy.component.Parameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code></a> <a class="reference internal" href="../api/hyperspy.component.html#hyperspy.component.Parameter.export" title="hyperspy.component.Parameter.export"><code class="xref py py-meth docutils literal notranslate"><span class="pre">export()</span></code></a>
methods can be used to export the result of the optimization in all supported
formats.</p>
</section>
</section>
<section id="batch-setting-of-parameter-attributes">
<h2>Batch setting of parameter attributes<a class="headerlink" href="#batch-setting-of-parameter-attributes" title="Permalink to this heading"></a></h2>
<p>The following model methods can be used to ease the task of setting some important
parameter attributes. These can also be used on a per-component basis, by calling them
on individual components.</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_not_free" title="hyperspy.model.BaseModel.set_parameters_not_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_free" title="hyperspy.model.BaseModel.set_parameters_free"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.set_parameters_value" title="hyperspy.model.BaseModel.set_parameters_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_value()</span></code></a></p></li>
</ul>
</section>
<section id="fitting-big-data">
<span id="modelfitbigdata-label"></span><h2>Fitting big data<a class="headerlink" href="#fitting-big-data" title="Permalink to this heading"></a></h2>
<p>See the section in <a class="reference internal" href="signal.html#signal-binned"><span class="std std-ref">Binned and unbinned signals</span></a> working with big data.</p>
</section>
<section id="smart-adaptive-multi-dimensional-fitting-samfire">
<span id="samfire-label"></span><h2>Smart Adaptive Multi-dimensional Fitting (SAMFire)<a class="headerlink" href="#smart-adaptive-multi-dimensional-fitting-samfire" title="Permalink to this heading"></a></h2>
<p>SAMFire (Smart Adaptive Multi-dimensional Fitting) is an algorithm created to
reduce the starting value (or local / false minima) problem, which often arises
when fitting multi-dimensional datasets.</p>
<p>The algorithm will be described in full when accompanying paper is published,
but we are making the implementation available now, with additional details
available in the following <a class="reference external" href="https://doi.org/10.1002/9783527808465.EMC2016.6233">conference proceeding</a>.</p>
<section id="the-idea">
<h3>The idea<a class="headerlink" href="#the-idea" title="Permalink to this heading"></a></h3>
<p>The main idea of SAMFire is to change two things compared to the traditional
way of fitting datasets with many dimensions in the navigation space:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Pick a more sensible pixel fitting order.</p></li>
<li><p>Calculate the pixel starting parameters from already fitted parts of the
dataset.</p></li>
</ol>
</div></blockquote>
<p>Both of these aspects are linked one to another and are represented by two
different strategy families that SAMFfire uses while operating.</p>
</section>
<section id="strategies">
<h3>Strategies<a class="headerlink" href="#strategies" title="Permalink to this heading"></a></h3>
<p>During operation SAMFire uses a list of strategies to determine how to select
the next pixel and estimate its starting parameters. Only one strategy is used
at a time. Next strategy is chosen when no new pixels can be fitted with
the current strategy. Once either the strategy list is exhausted or the full
dataset fitted, the algorithm terminates.</p>
<p>There are two families of strategies. In each family there may be many
strategies, using different statistical or significance measures.</p>
<p>As a rule of thumb, the first strategy in the list should always be from the
local family, followed by a strategy from the global family.</p>
</section>
<section id="local-strategy-family">
<h3>Local strategy family<a class="headerlink" href="#local-strategy-family" title="Permalink to this heading"></a></h3>
<p>These strategies assume that locally neighbouring pixels are similar. As a
result, the pixel fitting order seems to follow data-suggested order, and the
starting values are computed from the surrounding already fitted pixels.</p>
<p>More information about the exact procedure will be available once the
accompanying paper is published.</p>
</section>
<section id="global-strategy-family">
<h3>Global strategy family<a class="headerlink" href="#global-strategy-family" title="Permalink to this heading"></a></h3>
<p>Global strategies assume that the navigation coordinates of each pixel bear no
relation to it’s signal (i.e. the location of pixels is meaningless). As a
result, the pixels are selected at random to ensure uniform sampling of the
navigation space.</p>
<p>A number of candidate starting values are computed form global statistical
measures. These values are all attempted in order until a satisfactory result
is found (not necessarily testing all available starting guesses). As a result,
on average each pixel requires significantly more computations when compared to
a local strategy.</p>
<p>More information about the exact procedure will be available once the
accompanying paper is published.</p>
</section>
<section id="seed-points">
<h3>Seed points<a class="headerlink" href="#seed-points" title="Permalink to this heading"></a></h3>
<p>Due to the strategies using already fitted pixels to estimate the starting
values, at least one pixel has to be fitted beforehand by the user.</p>
<p>The seed pixel(s) should be selected to require the most complex model present
in the dataset, however in-built goodness of fit checks ensure that only
sufficiently well fitted values are allowed to propagate.</p>
<p>If the dataset consists of regions (in the navigation space) of highly
dissimilar pixels, often called “domain structures”, at least one seed pixel
should be given for each unique region.</p>
<p>If the starting pixels were not optimal, only part of the dataset will be
fitted. In such cases it is best to allow the algorithm terminate, then provide
new (better) seed pixels by hand, and restart SAMFire. It will use the
new seed together with the already computed parts of the data.</p>
</section>
<section id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h3>
<p>After creating a model and fitting suitable seed pixels, to fit the rest of
the multi-dimensional dataset using SAMFire we must create a SAMFire instance
as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">create_samfire</span><span class="p">(</span><span class="n">workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ipyparallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>By default SAMFire will look for an <a class="reference external" href="https://ipyparallel.readthedocs.io/">ipyparallel</a> cluster for the
workers for around 30 seconds. If none is available, it will use
multiprocessing instead.  However, if you are not planning to use ipyparallel,
it’s recommended specify it explicitly via the <code class="docutils literal notranslate"><span class="pre">ipyparallel=False</span></code> argument,
to use the fall-back option of <cite>multiprocessing</cite>.</p>
<p>By default a new SAMFire object already has two (and currently only) strategies
added to its <code class="docutils literal notranslate"><span class="pre">strategies</span></code> list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">strategies</span>
<span class="go">  A |    # | Strategy</span>
<span class="go"> -- | ---- | -------------------------</span>
<span class="go">  x |    0 | Reduced chi squared strategy</span>
<span class="go">    |    1 | Histogram global strategy</span>
</pre></div>
</div>
<p>The currently active strategy is marked by an ‘x’ in the first column.</p>
<p>If a new datapoint (i.e. pixel) is added manually, the “database” of the
currently active strategy has to be refreshed using the
<a class="reference internal" href="../api/hyperspy.samfire.html#hyperspy.samfire.Samfire.refresh_database" title="hyperspy.samfire.Samfire.refresh_database"><code class="xref py py-meth docutils literal notranslate"><span class="pre">refresh_database()</span></code></a> call.</p>
<p>The current strategy “database” can be plotted using the
<a class="reference internal" href="../api/hyperspy.samfire.html#hyperspy.samfire.Samfire.plot" title="hyperspy.samfire.Samfire.plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code></a> method.</p>
<p>Whilst SAMFire is running, each pixel is checked by a <code class="docutils literal notranslate"><span class="pre">goodness_test</span></code>,
which is by default
<code class="xref py py-class docutils literal notranslate"><span class="pre">red_chisq_test</span></code>,
checking the reduced chi-squared to be in the bounds of [0, 2].</p>
<p>This tolerance can (and most likely should!) be changed appropriately for the
data as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">goodness_test</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># use a sensible value</span>
</pre></div>
</div>
<p>The SAMFire managed multi-dimensional fit can be started using the
<a class="reference internal" href="../api/hyperspy.samfire.html#hyperspy.samfire.Samfire.start" title="hyperspy.samfire.Samfire.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start()</span></code></a> method. All keyword arguments are passed to
the underlying (i.e. usual) <a class="reference internal" href="../api/hyperspy.model.html#hyperspy.model.BaseModel.fit" title="hyperspy.model.BaseModel.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a> call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mva.html" class="btn btn-neutral float-left" title="Machine learning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="eels.html" class="btn btn-neutral float-right" title="Electron Energy Loss Spectroscopy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2011-2022, The HyperSpy development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>