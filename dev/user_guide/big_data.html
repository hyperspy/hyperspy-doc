
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../_static/hyperspy.ico" rel="icon" type="image/x-icon">
    <title>Working with big data &#8212; HyperSpy 2.0.2.dev42+g12e986f16 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom-styles.css?v=eff58afb" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9d061263"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-B0XD0GTW1M"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-B0XD0GTW1M');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-B0XD0GTW1M');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/big_data';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://hyperspy.org/hyperspy-doc/dev/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Region Of Interest (ROI)" href="region_of_interest.html" />
    <link rel="prev" title="Smart Adaptive Multi-dimensional Fitting (SAMFire)" href="model/SAMFire.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">HyperSpy API is changing in version 2.0, see the <a href='https://hyperspy.org/hyperspy-doc/current/changes.html'>release notes!</a></div>
  </div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/hyperspy_logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/hyperspy_logo.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">HyperSpy</p>
  
</a></div>
    
      <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../help.html">
                        Get Help
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../changes.html">
                        Release Notes
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../dev_guide/index.html">
                        Contribute
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/hyperspy/hyperspy-demos">
                    Tutorial
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/hyperspy/hyperspy" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitter.im/hyperspy/hyperspy" title="Gitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Gitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://hyperspy.org" title="HyperSpy" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/hyperspy.ico" class="icon-link-image" alt="HyperSpy"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../help.html">
                        Get Help
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../changes.html">
                        Release Notes
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../dev_guide/index.html">
                        Contribute
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/hyperspy/hyperspy-demos">
                    Tutorial
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/hyperspy/hyperspy" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitter.im/hyperspy/hyperspy" title="Gitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Gitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://hyperspy.org" title="HyperSpy" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/hyperspy.ico" class="icon-link-image" alt="HyperSpy"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing HyperSpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">Loading and saving data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Fundamentals and Usage</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="signal/index.html">The Signal class</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="signal/signal_basics.html">Basics of signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/ragged.html">Ragged signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/binned_signals.html">Binned and unbinned signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/indexing.html">Indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/generic_tools.html">Generic tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/basic_statistical_analysis.html">Basic statistical analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/setting_noise_properties.html">Setting the noise properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/speeding_up_operation.html">Speeding up operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/complex_datatype.html">Complex datatype</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal/gpu.html">GPU support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="axes.html">Axes handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal1d.html">Signal1D Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal2d.html">Signal2D Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Data visualization</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="mva/index.html">Machine learning</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="mva/decomposition.html">Decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="mva/bss.html">Blind Source Separation</a></li>
<li class="toctree-l2"><a class="reference internal" href="mva/clustering.html">Cluster analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="mva/visualize_results.html">Visualizing results</a></li>
<li class="toctree-l2"><a class="reference internal" href="mva/export_results.html">Export results</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="model/index.html">Model fitting</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="model/creating_model.html">Creating a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/model_components.html">Model components</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/adding_components.html">Adding components to the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/indexing_model.html">Indexing the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/model_parameters.html">Getting and setting parameter values and attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/fitting_model.html">Fitting the model to the data</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/storing_models.html">Storing models</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/fitting_big_data.html">Fitting big data</a></li>
<li class="toctree-l2"><a class="reference internal" href="model/SAMFire.html">Smart Adaptive Multi-dimensional Fitting (SAMFire)</a></li>
</ul>
</li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Working with big data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced Usage</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="region_of_interest.html">Region Of Interest (ROI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactive_operations.html">Interactive Operations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Working...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="working-with-big-data">
<span id="big-data-label"></span><h1>Working with big data<a class="headerlink" href="#working-with-big-data" title="Link to this heading">#</a></h1>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.2.</span></p>
</div>
<p>HyperSpy makes it possible to analyse data larger than the available memory by
providing “lazy” versions of most of its signals and functions. In most cases
the syntax remains the same. This chapter describes how to work with data
larger than memory using the <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal" title="hyperspy._signals.lazy.LazySignal"><code class="xref py py-class docutils literal notranslate"><span class="pre">LazySignal</span></code></a> class and
its derivatives.</p>
<section id="creating-lazy-signals">
<h2>Creating Lazy Signals<a class="headerlink" href="#creating-lazy-signals" title="Link to this heading">#</a></h2>
<section id="lazy-signals-from-external-data">
<h3>Lazy Signals from external data<a class="headerlink" href="#lazy-signals-from-external-data" title="Link to this heading">#</a></h3>
<p>If the data is large and not loaded by HyperSpy (for example a <code class="docutils literal notranslate"><span class="pre">hdf5.Dataset</span></code>
or similar), first wrap it in <code class="docutils literal notranslate"><span class="pre">dask.array.Array</span></code> as shown <a class="reference external" href="https://dask.readthedocs.io/en/latest/array-creation.html">here</a> and then pass it
as normal and call <code class="docutils literal notranslate"><span class="pre">as_lazy()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">h5py</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;myfile.hdf5&quot;</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/data/path&#39;</span><span class="p">]</span> 

<span class="go">Wrap the data in dask and chunk as appropriate</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> 

<span class="go">Create the lazy signal</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span> 
</pre></div>
</div>
</section>
<section id="loading-lazily">
<h3>Loading lazily<a class="headerlink" href="#loading-lazily" title="Link to this heading">#</a></h3>
<p>To load the data lazily, pass the keyword <code class="docutils literal notranslate"><span class="pre">lazy=True</span></code>.  As an example,
loading a 34.9 GB <code class="docutils literal notranslate"><span class="pre">.blo</span></code> file on a regular laptop might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;shish26.02-6.blo&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> 
<span class="go">&lt;LazySignal2D, title: , dimensions: (400, 333|512, 512)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">data</span> 
<span class="go">dask.array&lt;array-e..., shape=(333, 400, 512, 512), dtype=uint8, chunksize=(20, 12, 512, 512)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span> 
<span class="go">uint8 34.9175808</span>

<span class="go">Change dtype to perform decomposition, etc.</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">change_dtype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>  
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span> 
<span class="go">float64 279.3406464</span>
</pre></div>
</div>
<p>Loading the dataset in the original unsigned integer format would require
around 35GB of memory. To store it in a floating-point format one would need
almost 280GB of memory. However, with the lazy processing both of these steps
are near-instantaneous and require very little computational resources.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4: </span><a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.close_file" title="hyperspy._signals.lazy.LazySignal.close_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close_file()</span></code></a></p>
</div>
<p>Currently when loading an hdf5 file lazily the file remains open at
least while the signal exists. In order to close it explicitly, use the
<a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.close_file" title="hyperspy._signals.lazy.LazySignal.close_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close_file()</span></code></a> method. Alternatively,
you could close it on calling <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.compute" title="hyperspy._signals.lazy.LazySignal.compute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compute()</span></code></a>
by passing the keyword argument <code class="docutils literal notranslate"><span class="pre">close_file=True</span></code> e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;file.hspy&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">ssum</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

<span class="go">Close the file</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ssum</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">close_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</pre></div>
</div>
</section>
<section id="lazy-stacking">
<h3>Lazy stacking<a class="headerlink" href="#lazy-stacking" title="Link to this heading">#</a></h3>
<p>Occasionally the full dataset consists of many smaller files. To combine them
into a one large <code class="docutils literal notranslate"><span class="pre">LazySignal</span></code>, we can <a class="reference internal" href="signal/generic_tools.html#signal-stack-split"><span class="std std-ref">stack</span></a> them
lazily (both when loading or afterwards):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">siglist</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;*.hdf5&quot;</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">siglist</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="go">Or load lazily and stack afterwards:</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">siglist</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;*.hdf5&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="go">Make a stack, no need to pass &#39;lazy&#39;, as signals are already lazy</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">siglist</span><span class="p">)</span> 

<span class="go">Or do everything in one go:</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;*.hdf5&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</pre></div>
</div>
</section>
<section id="casting-signals-as-lazy">
<h3>Casting signals as lazy<a class="headerlink" href="#casting-signals-as-lazy" title="Link to this heading">#</a></h3>
<p>To convert a regular HyperSpy signal to a lazy one such that any future
operations are only performed lazily, use the
<a class="reference internal" href="../reference/api.signals/BaseSignal.html#hyperspy.api.signals.BaseSignal.as_lazy" title="hyperspy.api.signals.BaseSignal.as_lazy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">as_lazy()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">150.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;Signal1D, title: , dimensions: (3|50)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sl</span>
<span class="go">&lt;LazySignal1D, title: , dimensions: (3|50)&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="machine-learning">
<span id="big-data-decomposition"></span><h2>Machine learning<a class="headerlink" href="#machine-learning" title="Link to this heading">#</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The machine learning features are in beta state.</p>
<p>Although most of them work as described, their operation may not always
be optimal, well-documented and/or consistent with their in-memory counterparts.</p>
</div>
<p><a class="reference internal" href="mva/decomposition.html#mva-decomposition"><span class="std std-ref">Decomposition</span></a> algorithms for machine learning often perform
large matrix manipulations, requiring significantly more memory than the data size.
To perform decomposition operation lazily, HyperSpy provides access to several “online”
algorithms  as well as <a class="reference external" href="https://dask.pydata.org/">dask</a>’s lazy SVD algorithm.
Online algorithms perform the decomposition by operating serially on chunks of
data, enabling the lazy decomposition of large datasets. In line with the
standard HyperSpy signals, lazy <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.decomposition" title="hyperspy._signals.lazy.LazySignal.decomposition"><code class="xref py py-meth docutils literal notranslate"><span class="pre">decomposition()</span></code></a>
offers the following online algorithms:</p>
<span id="lazy-decomposition-table"></span><table class="table" id="id2">
<caption><span class="caption-text">Available lazy decomposition algorithms in HyperSpy</span><a class="headerlink" href="#id2" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Algorithm</p></th>
<th class="head"><p>Method</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>“SVD” (default)</p></td>
<td><p><a class="reference external" href="https://docs.dask.org/en/latest/generated/dask.array.linalg.svd.html#dask.array.linalg.svd" title="(in Dask)"><code class="xref py py-func docutils literal notranslate"><span class="pre">dask.array.linalg.svd()</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p>“PCA”</p></td>
<td><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.IncrementalPCA.html#sklearn.decomposition.IncrementalPCA" title="(in scikit-learn v1.4)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.decomposition.IncrementalPCA</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p>“ORPCA”</p></td>
<td><p><a class="reference internal" href="../reference/base_classes/machine_learning.html#hyperspy.learn.rpca.ORPCA" title="hyperspy.learn.rpca.ORPCA"><code class="xref py py-class docutils literal notranslate"><span class="pre">ORPCA</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p>“ORNMF”</p></td>
<td><p><a class="reference internal" href="../reference/base_classes/machine_learning.html#hyperspy.learn.ornmf.ORNMF" title="hyperspy.learn.ornmf.ORNMF"><code class="xref py py-class docutils literal notranslate"><span class="pre">ORNMF</span></code></a></p></td>
</tr>
</tbody>
</table>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../reference/api.signals/BaseSignal.html#hyperspy.api.signals.BaseSignal.decomposition" title="hyperspy.api.signals.BaseSignal.decomposition"><code class="xref py py-meth docutils literal notranslate"><span class="pre">decomposition()</span></code></a> for more details on decomposition
with non-lazy signals.</p>
</div>
</section>
<section id="navigator-plot">
<h2>Navigator plot<a class="headerlink" href="#navigator-plot" title="Link to this heading">#</a></h2>
<p>The default signal navigator is the sum of the signal across all signal
dimensions and all but 1 or 2 navigation dimensions. If the dataset is large,
this can take a significant amount of time to perform with every plot.
By default, a navigator is computed with minimally required approach to obtain
a good signal-to-noise ratio image: the sum is taken on a single chunk of the
signal space, in order to avoid to compute the navigator for the whole dataset.
In the following example, the signal space is divided in 25 chunks (5 along on
each axis), and therefore computing the navigation will only be perfomed over
a small subset of the whole dataset by taking the sum on only 1 chunk out
of 25:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">hyperspy.api</span> <span class="k">as</span> <span class="nn">hs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</pre></div>
</div>
<p>In the example above, the calculation of the navigation is fast but the actual
visualisation of the dataset is slow, each for each navigation index change,
25 chunks of the dataset needs to be fetched from the harddrive. In the
following example, the signal space contains a single chunk (instead of 25, in
the previous example) and the calculating the navigator will then be slower (~20x)
because the whole dataset will need to processed, however in this case, the
visualisation will be faster, because only a single chunk will fetched from the
harddrive when changing navigation indices:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</pre></div>
</div>
<p>This approach depends heavily on the chunking of the data and may not be
always suitable. The <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.compute_navigator" title="hyperspy._signals.lazy.LazySignal.compute_navigator"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compute_navigator()</span></code></a>
can be used to calculate the navigator efficient and store the navigator, so
that it can be used when plotting and saved for the later loading of the dataset.
The <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.compute_navigator" title="hyperspy._signals.lazy.LazySignal.compute_navigator"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compute_navigator()</span></code></a> has optional
argument to specify the index where the sum needs to be calculated and how to
rechunk the dataset when calculating the navigator. This allows to
efficiently calculate the navigator without changing the actual chunking of the
dataset, since the rechunking only takes during the computation of the navigator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute_navigator</span><span class="p">(</span><span class="n">chunks_number</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal2D, title: , dimensions: (100, 100|400, 2000)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute_navigator</span><span class="p">(</span><span class="n">chunks_number</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">navigator</span><span class="o">.</span><span class="n">original_metadata</span>
<span class="go">└── sum_from = [slice(200, 400, None), slice(1000, 1200, None)]</span>
</pre></div>
</div>
<p>The index can also be specified following the
<a class="reference internal" href="signal/indexing.html#signal-indexing"><span class="std std-ref">HyperSpy indexing signal1D</span></a> syntax for float and
interger.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal2D, title: , dimensions: (100, 100|400, 2000)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute_navigator</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks_number</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">navigator</span><span class="o">.</span><span class="n">original_metadata</span>
<span class="go">└── sum_from = [slice(0, 200, None), slice(0, 200, None)]</span>
</pre></div>
</div>
<p>An alternative is to calculate the navigator separately and store it in the
signal using the <code class="xref py py-attr docutils literal notranslate"><span class="pre">navigator</span></code> setter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal2D, title: , dimensions: (100, 100|1000, 1000)&gt;</span>
</pre></div>
</div>
<p>For fastest results, just pick one signal space pixel</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nav</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">isig</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
</pre></div>
</div>
<p>Alternatively, sum as per default behaviour of non-lazy signal</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nav</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">axes_manager</span><span class="o">.</span><span class="n">signal_axes</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">nav</span> 
<span class="go">&lt;LazySignal2D, title: , dimensions: (|100, 100)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nav</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
<span class="go">[########################################] | 100% Completed | 13.1s</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">navigator</span> <span class="o">=</span> <span class="n">nav</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</pre></div>
</div>
<p>Alternatively, it is possible to not have a navigator, and use sliders instead</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal2D, title: , dimensions: (100, 100|1000, 1000)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">navigator</span><span class="o">=</span><span class="s1">&#39;slider&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.7.</span></p>
</div>
</section>
<section id="gpu-support">
<span id="big-data-gpu"></span><h2>GPU support<a class="headerlink" href="#gpu-support" title="Link to this heading">#</a></h2>
<p>Lazy data processing on GPUs requires explicitly transferring the data to the
GPU.</p>
<p>On linux, it is recommended to use the
<a class="reference external" href="https://docs.rapids.ai/api/dask-cuda/stable/index.html">dask_cuda</a> library
(not supported on windows) to manage the dask scheduler. As for CPU lazy
processing, if the dask scheduler is not specified, the default scheduler
will be used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">()</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> 
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>

<span class="go">Create a dask array</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span>
<span class="go">dask.array&lt;random_sample, shape=(20, 20, 100, 100), dtype=float64, chunksize=(20, 20, 100, 100), chunktype=numpy.ndarray&gt;</span>

<span class="go">Convert the dask chunks from numpy array to cupy array</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> 
<span class="go">dask.array&lt;random_sample, shape=(20, 20, 100, 100), dtype=float64, chunksize=(20, 20, 100, 100), chunktype=cupy.ndarray&gt;</span>

<span class="go">Create the signal</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span> 
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the dask blog on <a class="reference external" href="https://blog.dask.org/2020/11/12/deconvolution">Richardson Lucy (RL) deconvolution</a>
for an example of lazy processing on GPUs using dask and cupy</p>
</div>
</section>
<section id="model-fitting">
<span id="fitbigdata-label"></span><h2>Model fitting<a class="headerlink" href="#model-fitting" title="Link to this heading">#</a></h2>
<p>Most curve-fitting functionality will automatically work on models created from
lazily loaded signals. HyperSpy extracts the relevant chunk from the signal and fits to that.</p>
<p>The linear <code class="docutils literal notranslate"><span class="pre">'lstsq'</span></code> optimizer supports fitting the entire dataset in a vectorised manner
using <a class="reference external" href="https://docs.dask.org/en/latest/generated/dask.array.linalg.lstsq.html#dask.array.linalg.lstsq" title="(in Dask)"><code class="xref py py-func docutils literal notranslate"><span class="pre">dask.array.linalg.lstsq()</span></code></a>. This can give potentially enormous performance benefits over fitting
with a nonlinear optimizer, but comes with the restrictions explained in the <a class="reference internal" href="model/fitting_model.html#linear-fitting-label"><span class="std std-ref">linear fitting</span></a> section.</p>
</section>
<section id="practical-tips">
<h2>Practical tips<a class="headerlink" href="#practical-tips" title="Link to this heading">#</a></h2>
<p>Despite the limitations detailed below, most HyperSpy operations can be
performed lazily. Important points are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#big-data-chunking"><span class="std std-ref">Chunking</span></a></p></li>
<li><p><a class="reference internal" href="#compute-lazy-signals"><span class="std std-ref">Computing lazy signals</span></a></p></li>
<li><p><a class="reference internal" href="#lazy-operations-axes"><span class="std std-ref">Lazy operations that affect the axes</span></a></p></li>
</ul>
<section id="chunking">
<span id="big-data-chunking"></span><h3>Chunking<a class="headerlink" href="#chunking" title="Link to this heading">#</a></h3>
<p>Data saved in the HDF5 format is typically divided into smaller chunks which can be loaded separately into memory,
allowing lazy loading. Chunk size can dramatically affect the speed of various HyperSpy algorithms, so chunk size is
worth careful consideration when saving a signal. HyperSpy’s default chunking sizes are probably not optimal
for a given data analysis technique. For more comprehensible documentation on chunking,
see the dask <a class="reference external" href="https://docs.dask.org/en/latest/array-chunks.html">array chunks</a> and <a class="reference external" href="https://docs.dask.org/en/latest/array-best-practices.html">best practices</a> docs. The chunks saved into HDF5 will
match the dask array chunks in <code class="docutils literal notranslate"><span class="pre">s.data.chunks</span></code> when lazy loading.
Chunk shape should follow the axes order of the numpy shape (<code class="docutils literal notranslate"><span class="pre">s.data.shape</span></code>), not the hyperspy shape.
The following example shows how to chunk one of the two navigation dimensions into smaller chunks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="o">.</span><span class="n">chunksize</span>
<span class="go">(10, 200, 300)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>

<span class="go">Note the reversed order of navigation dimensions</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal1D, title: , dimensions: (200, 10|300)&gt;</span>

<span class="go">Save data with chunking first hyperspy dimension (second array dimension)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;chunked_signal.zspy&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;chunked_signal.zspy&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunksize</span> 
<span class="go">(10, 100, 300)</span>
</pre></div>
</div>
<p>To get the chunk size of given axes, the <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.get_chunk_size" title="hyperspy._signals.lazy.LazySignal.get_chunk_size"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_chunk_size()</span></code></a>
method can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="o">.</span><span class="n">chunksize</span>
<span class="go">(10, 200, 300)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">get_chunk_size</span><span class="p">()</span> <span class="c1"># All navigation axes</span>
<span class="go">((10,), (200,))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">get_chunk_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># The first navigation axis</span>
<span class="go">((200,),)</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.0.</span></p>
</div>
<p>Starting in version 2.0.0 HyperSpy does not automatically rechunk datasets as
this can lead to reduced performance. The <code class="docutils literal notranslate"><span class="pre">rechunk</span></code> or <code class="docutils literal notranslate"><span class="pre">optimize</span></code> keyword argument
can be set to <code class="docutils literal notranslate"><span class="pre">True</span></code> to let HyperSpy automatically change the chunking which
could potentially speed up operations.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.7.0.</span></p>
</div>
<p id="lazy-repr-html">For more recent versions of dask (dask&gt;2021.11) when using hyperspy in a jupyter
notebook a helpful html representation is available.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> 
</pre></div>
</div>
<figure class="align-default">
<img alt="../_images/chunks.png" src="../_images/chunks.png" />
</figure>
<p>This helps to visualize the chunk structure and identify axes where the chunk spans the entire
axis (bolded axes).</p>
</section>
<section id="computing-lazy-signals">
<span id="compute-lazy-signals"></span><h3>Computing lazy signals<a class="headerlink" href="#computing-lazy-signals" title="Link to this heading">#</a></h3>
<p>Upon saving lazy signals, the result of computations is stored on disk.</p>
<p>In order to store the lazy signal in memory (i.e. make it a normal HyperSpy
signal) it has a <a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal.compute" title="hyperspy._signals.lazy.LazySignal.compute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compute()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">&lt;LazySignal2D, title: , dimensions: (10, 20, 20|10, 10)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
<span class="go">[########################################] | 100% Completed |  0.1s</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> 
<span class="go">&lt;Signal2D, title: , dimensions: (10, 20, 20|10, 10)&gt;</span>
</pre></div>
</div>
</section>
<section id="lazy-operations-that-affect-the-axes">
<span id="lazy-operations-axes"></span><h3>Lazy operations that affect the axes<a class="headerlink" href="#lazy-operations-that-affect-the-axes" title="Link to this heading">#</a></h3>
<p>When using lazy signals the computation of the data is delayed until
requested. However, the changes to the axes properties are performed
when running a given function that modfies them i.e. they are not
performed lazily. This can lead to hard to debug issues when the result
of a given function that is computed lazily depends on the value of the
axes parameters that <em>may have changed</em> before the computation is requested.
Therefore, in order to avoid such issues, it is reccomended to explicitly
compute the result of all functions that are affected by the axes
parameters. This is the reason why e.g. the result of
<a class="reference internal" href="../reference/api.signals/Signal1D.html#hyperspy.api.signals.Signal1D.shift1D" title="hyperspy.api.signals.Signal1D.shift1D"><code class="xref py py-meth docutils literal notranslate"><span class="pre">shift1D()</span></code></a> is not lazy.</p>
</section>
</section>
<section id="dask-backends">
<span id="id1"></span><h2>Dask Backends<a class="headerlink" href="#dask-backends" title="Link to this heading">#</a></h2>
<p>Dask is a flexible library for parallel computing in Python. All of the lazy operations in
hyperspy run through dask. Dask can be used to run computations on a single machine or
scaled to a cluster. The following example shows how to use dask to run computations on a
variety of different hardware:</p>
<section id="single-threaded-scheduler">
<h3>Single Threaded Scheduler<a class="headerlink" href="#single-threaded-scheduler" title="Link to this heading">#</a></h3>
<p>The single threaded scheduler in dask is useful for debugging and testing. It is not
recommended for general use.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">hyperspy.api</span> <span class="k">as</span> <span class="nn">hs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>

<span class="go">Set the scheduler to single-threaded globally</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;single-threaded&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<p>Alternatively, you can set the scheduler to single-threaded for a single function call by
setting the <code class="docutils literal notranslate"><span class="pre">scheduler</span></code> keyword argument to <code class="docutils literal notranslate"><span class="pre">'single-threaded'</span></code>.</p>
<p>Or for something like plotting you can set the scheduler to single-threaded for the
duration of the plotting call by using the <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">dask.config.set</span></code> context manager.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s2">&quot;single-threaded&quot;</span><span class="p">)</span> 

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;single-threaded&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</pre></div>
</div>
</section>
<section id="single-machine-schedulers">
<h3>Single Machine Schedulers<a class="headerlink" href="#single-machine-schedulers" title="Link to this heading">#</a></h3>
<p>Dask has two schedulers available for single machines.</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Threaded Scheduler:</dt><dd><p>Fastest to set up but only provides parallelism through threads so only non python functions will be parallelized.
This is good if you have largely numpy code and not too many cores.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Processes Scheduler:</dt><dd><p>Each task (and all of the necessary dependencies) are shipped to different processes.  As such it has a larger set
up time. This preforms well for python dominated code.</p>
</dd>
</dl>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">)</span> 

<span class="go">Any hyperspy code will now use the multiprocessing scheduler</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  

<span class="go">Change to threaded Scheduler, overwrite default</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
</pre></div>
</div>
</section>
<section id="distributed-scheduler">
<h3>Distributed Scheduler<a class="headerlink" href="#distributed-scheduler" title="Link to this heading">#</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Distributed computing is not supported for all file formats.</p>
<p>Distributed computing is limited to a few file formats, see the list of
<a class="reference external" href="https://hyperspy.org/rosettasciio/user_guide/supported_formats/index.html#supported-formats" title="(in RosettaSciIO)"><span class="xref std std-ref">supported file format</span></a> in
RosettaSciIO documentation.</p>
</div>
<p>The recommended way to use dask is with the distributed scheduler. This allows you to scale your computations
to a cluster of machines. The distributed scheduler can be used on a single machine as well. <code class="docutils literal notranslate"><span class="pre">dask-distributed</span></code>
also gives you access to the dask dashboard which allows you to monitor your computations.</p>
<p>Some operations such as the matrix decomposition algorithms in hyperspy don’t currently work with
the distributed scheduler.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">LocalCluster</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">hyperspy.api</span> <span class="k">as</span> <span class="nn">hs</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">()</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> 

<span class="go">Any calculation will now use the distributed scheduler</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
</pre></div>
</div>
<p>Running computation on remote cluster can be done easily using <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">SLURMCluster</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">cluster</span> <span class="o">=</span> <span class="n">SLURMCluster</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">memory</span><span class="o">=</span><span class="s1">&#39;120Gb&#39;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;01:00:00&quot;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;research&#39;</span><span class="p">)</span> 

<span class="go">Get 3 nodes</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> 
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> 
</pre></div>
</div>
<p>Any calculation will now use the distributed scheduler</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">repeated_data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span><span class="mi">10</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">repeated_data</span><span class="p">)</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">summed</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
</pre></div>
</div>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<p>Most operations can be performed lazily. However, lazy operations come with
a few limitations and constraints that we detail below.</p>
<section id="immutable-signals">
<h3>Immutable signals<a class="headerlink" href="#immutable-signals" title="Link to this heading">#</a></h3>
<p>An important limitation when using <code class="docutils literal notranslate"><span class="pre">LazySignal</span></code> is the inability to modify
existing data (immutability). This is a logical consequence of the DAG (tree
structure, explained in <a class="reference internal" href="#lazy-details"><span class="std std-ref">Behind the scenes – technical details</span></a>), where a complete history of the
processing has to be stored to traverse later.</p>
<p>In fact, lazy evaluation removes the need for such operation, since only
additional tree branches are added, requiring very little resources. In
practical terms the following fails with lazy signals:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">BaseSignal</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span> 
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;ipython-input-6-1bd1db4187be&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="w">    </span><span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span>
  File <span class="nb">&quot;&lt;string&gt;&quot;</span>, line <span class="m">2</span>, in <span class="n">__iadd__</span>
  File <span class="nb">&quot;/home/fjd29/Python/hyperspy3/hyperspy/signal.py&quot;</span>, line <span class="m">1591</span>, in <span class="n">_binary_operator_ruler</span>
<span class="w">    </span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">op_name</span><span class="p">)(</span><span class="n">other</span><span class="p">)</span>
<span class="gr">AttributeError</span>: <span class="n">&#39;Array&#39; object has no attribute &#39;__iadd__&#39;</span>
</pre></div>
</div>
<p>However, when operating lazily there is no clear benefit to using in-place
operations. So, the operation above could be rewritten as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">BaseSignal</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Or even better:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">BaseSignal</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">as_lazy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="other-minor-differences">
<h3>Other minor differences<a class="headerlink" href="#other-minor-differences" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Histograms</strong> for a <code class="docutils literal notranslate"><span class="pre">LazySignal</span></code> do not support <code class="docutils literal notranslate"><span class="pre">knuth</span></code> and <code class="docutils literal notranslate"><span class="pre">blocks</span></code>
binning algorithms.</p></li>
<li><p><strong>CircleROI</strong> sets the elements outside the ROI to <code class="docutils literal notranslate"><span class="pre">np.nan</span></code> instead of
using a masked array, because <code class="docutils literal notranslate"><span class="pre">dask</span></code> does not support masking. As a
convenience, <code class="docutils literal notranslate"><span class="pre">nansum</span></code>, <code class="docutils literal notranslate"><span class="pre">nanmean</span></code> and other <code class="docutils literal notranslate"><span class="pre">nan*</span></code> signal methods were
added to mimic the workflow as closely as possible.</p></li>
</ul>
</section>
<section id="saving-big-data">
<span id="big-data-saving"></span><h3>Saving Big Data<a class="headerlink" href="#saving-big-data" title="Link to this heading">#</a></h3>
<p>The most efficient format supported by HyperSpy to write data is the
<a class="reference external" href="https://hyperspy.org/rosettasciio/user_guide/supported_formats/zspy.html#zspy-format" title="(in RosettaSciIO)"><span class="xref std std-ref">ZSpy format</span></a>,
mainly because it supports writing concurrently from multiple threads or processes.
This also allows for smooth interaction with dask-distributed for efficient scaling.</p>
</section>
</section>
<section id="behind-the-scenes-technical-details">
<span id="lazy-details"></span><h2>Behind the scenes – technical details<a class="headerlink" href="#behind-the-scenes-technical-details" title="Link to this heading">#</a></h2>
<p>Standard HyperSpy signals load the data into memory for fast access and
processing. While this behaviour gives good performance in terms of speed, it
obviously requires at least as much computer memory as the dataset, and often
twice that to store the results of subsequent computations. This can become a
significant problem when processing very large datasets on consumer-oriented
hardware.</p>
<p>HyperSpy offers a solution for this problem by including
<a class="reference internal" href="../reference/base_classes/signal/LazySignal.html#hyperspy._signals.lazy.LazySignal" title="hyperspy._signals.lazy.LazySignal"><code class="xref py py-class docutils literal notranslate"><span class="pre">LazySignal</span></code></a> and its derivatives. The main idea of
these classes is to perform any operation (as the name suggests)
<a class="reference external" href="https://en.wikipedia.org/wiki/Lazy_evaluation">lazily</a> (delaying the
execution until the result is requested (e.g. saved, plotted)) and in a
<a class="reference external" href="https://en.wikipedia.org/wiki/Block_matrix">blocked fashion</a>. This is
achieved by building a “history tree” (formally called a Directed Acyclic Graph
(DAG)) of the computations, where the original data is at the root, and any
further operations branch from it. Only when a certain branch result is
requested, the way to the root is found and evaluated in the correct sequence
on the correct blocks.</p>
<p>The “magic” is performed by (for the sake of simplicity) storing the data not
as <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code>, but <code class="docutils literal notranslate"><span class="pre">dask.array.Array</span></code> (see the
<a class="reference external" href="https://dask.readthedocs.io/en/latest/">dask documentation</a>). <code class="docutils literal notranslate"><span class="pre">dask</span></code>
offers a couple of advantages:</p>
<ul class="simple">
<li><p><strong>Arbitrary-sized data processing is possible</strong>. By only loading a couple of
chunks at a time, theoretically any signal can be processed, albeit slower.
In practice, this may be limited: (i) some operations may require certain
chunking pattern, which may still saturate memory; (ii) many chunks should
fit into the computer memory comfortably at the same time.</p></li>
<li><p><strong>Loading only the required data</strong>. If a certain part (chunk) of the data is
not required for the final result, it will not be loaded at all, saving time
and resources.</p></li>
<li><p><strong>Able to extend to a distributed computing environment (clusters)</strong>.
:<code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code> (see
<a class="reference external" href="https://distributed.readthedocs.io/en/latest/">the dask documentation</a>) offers
a straightforward way to expand the effective memory for computations to that
of a cluster, which allows performing the operations significantly faster
than on a single machine.</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="model/SAMFire.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Smart Adaptive Multi-dimensional Fitting (SAMFire)</p>
      </div>
    </a>
    <a class="right-next"
       href="region_of_interest.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Region Of Interest (ROI)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-lazy-signals">Creating Lazy Signals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-signals-from-external-data">Lazy Signals from external data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-lazily">Loading lazily</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-stacking">Lazy stacking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#casting-signals-as-lazy">Casting signals as lazy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning">Machine learning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#navigator-plot">Navigator plot</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gpu-support">GPU support</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-fitting">Model fitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-tips">Practical tips</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chunking">Chunking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-lazy-signals">Computing lazy signals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-operations-that-affect-the-axes">Lazy operations that affect the axes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dask-backends">Dask Backends</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-threaded-scheduler">Single Threaded Scheduler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-machine-schedulers">Single Machine Schedulers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-scheduler">Distributed Scheduler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#immutable-signals">Immutable signals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-minor-differences">Other minor differences</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-big-data">Saving Big Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#behind-the-scenes-technical-details">Behind the scenes – technical details</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/big_data.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2011-2024, The HyperSpy development team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>