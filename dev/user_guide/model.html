

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Model fitting &mdash; HyperSpy 1.3.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/hyperspy.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Electron Energy Loss Spectroscopy" href="eels.html" />
    <link rel="prev" title="Machine learning" href="mva.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> HyperSpy
          

          
            
            <img src="../_static/hyperspy_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">HyperSpy User Guide (DRAFT)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="what_is_new.html">What’s new</a></li>
<li class="toctree-l2"><a class="reference internal" href="what_is_new.html#changelog">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html">Installing HyperSpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html">Tools: the Signal class</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal1d.html">Signal1D Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal2d.html">Signal2D Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualisation.html">Data visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="mva.html">Machine learning</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Model fitting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-model">Creating a model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-components-to-the-model">Adding components to the model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#specifying-custom-components">Specifying custom components</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#indexing-the-model">Indexing the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-and-setting-parameter-values-and-attributes">Getting and setting parameter values and attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-the-model-to-the-data">Fitting the model to the data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#visualizing-the-model">Visualizing the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-the-initial-parameters">Setting the initial parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exclude-data-from-the-fitting-process">Exclude data from the fitting process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fitting-multidimensional-datasets">Fitting multidimensional datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualising-the-result-of-the-fit">Visualising the result of the fit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#storing-models">Storing models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#saving-and-loading-the-result-of-the-fit">Saving and loading the result of the fit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exporting-the-result-of-the-fit">Exporting the result of the fit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#batch-setting-of-parameter-attributes">Batch setting of parameter attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#smart-adaptive-multi-dimensional-fitting-samfire">Smart Adaptive Multi-dimensional Fitting (SAMFire)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-idea">The idea</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategies">Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-strategy-family">Local strategy family</a></li>
<li class="toctree-l4"><a class="reference internal" href="#global-strategy-family">Global strategy family</a></li>
<li class="toctree-l4"><a class="reference internal" href="#seed-points">Seed points</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="eels.html">Electron Energy Loss Spectroscopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="eds.html">Energy-Dispersive X-ray Spectrometry (EDS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="dielectric_function.html">Dielectric function tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="electron_holography.html">Electron Holography</a></li>
<li class="toctree-l2"><a class="reference internal" href="io.html">Loading and saving data</a></li>
<li class="toctree-l2"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="big_data.html">Working with big data</a></li>
<li class="toctree-l2"><a class="reference internal" href="metadata_structure.html">Metadata structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">Full HyperSpy API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing HyperSpy</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HyperSpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">HyperSpy User Guide (DRAFT)</a> &raquo;</li>
        
      <li>Model fitting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/user_guide/model.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="model-fitting">
<h1>Model fitting<a class="headerlink" href="#model-fitting" title="Permalink to this headline">¶</a></h1>
<p>HyperSpy can perform curve fitting of one-dimensional signals (spectra) and
two-dimensional signals (images) in n-dimensional data sets. Models can be
created as a linear combination of predefined components and multiple
optimisation algorithms can be used to fit the model to experimental data.
Bounds and weights are supported. The syntax for creating both kinds of model
is essentially the same, as in this documentation any method referred to in
the <code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code> class is available for both kinds.</p>
<div class="versionadded" id="d-model-label">
<p><span class="versionmodified">New in version 1.0: </span>2D models. Note that this first implementation lacks many of the
features of 1D models e.g. plotting. Those will be added in future releases.</p>
</div>
<p>Models can be created and and fit to experimental data in both one and two
dimensions i.e. spectra and images respectively. Most of the syntax is
identical in either case. A one-dimensional model is created when a model
is created for a <code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code> whereas a two-
dimensional model is created for a <code class="xref py py-class docutils literal notranslate"><span class="pre">_signals.signal2D.Signal2D</span></code>.
At present plotting and gradient fitting methods tools for are not yet
provided for the <code class="xref py py-class docutils literal notranslate"><span class="pre">Model2D</span></code> class.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7: </span>Binned/unbinned signals</p>
</div>
<p>Before creating a model verify that the <code class="docutils literal notranslate"><span class="pre">Signal.binned</span></code> metadata
attribute of the signal is set to the correct value because the resulting
model depends on this parameter. See <a class="reference internal" href="tools.html#signal-binned"><span class="std std-ref">Binned and unbinned signals</span></a> for more details.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When importing data that have been binned using other software, in
particular Gatan’s DM, the stored values may be the averages of the
binned channels or pixels, instead of their sum, as would be required
for proper statistical analysis. We therefore cannot guarantee that
the statistics will be valid. We therefore strongly recommend that all
pre-fitting binning should be done using Hyperspy.</p>
</div>
<div class="section" id="creating-a-model">
<h2>Creating a model<a class="headerlink" href="#creating-a-model" title="Permalink to this headline">¶</a></h2>
<p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">Model1D</span></code> can be created for data in the
<code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code> class using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">create_model()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span> <span class="c1"># Creates the 1D-Model and assign it to m</span>
</pre></div>
</div>
<p>Similarly A <code class="xref py py-class docutils literal notranslate"><span class="pre">Model2D</span></code> can be created for data in the
<code class="xref py py-class docutils literal notranslate"><span class="pre">Signal2D</span></code> class using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">create_model()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal2D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mod</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span> <span class="c1"># Create the 2D-Model and assign it to mod</span>
</pre></div>
</div>
<p>The syntax for creating both one-dimensional and two-dimensional models is thus
identical for the user in practice. When a model is created  you may be
prompted to provide important information not already included in the
datafile, e.g.if s is EELS data, you may be asked for the accelerating
voltage, convergence and collection semi-angles etc.</p>
</div>
<div class="section" id="adding-components-to-the-model">
<span id="model-components-label"></span><h2>Adding components to the model<a class="headerlink" href="#adding-components-to-the-model" title="Permalink to this headline">¶</a></h2>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.0: </span><cite>hyperspy.api.model.components</cite> renamed to
<cite>hyperspy.api.model.components1D</cite></p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0: </span><cite>hyperspy.api.model.components2D</cite>.</p>
</div>
<p>In HyperSpy a model consists of a linear combination of components
and various components are available in one (<code class="xref py py-mod docutils literal notranslate"><span class="pre">components1d</span></code>)and
two-dimensions (<code class="xref py py-mod docutils literal notranslate"><span class="pre">components2d</span></code>) to construct a
model.</p>
<p>The following components are currently available for one-dimensional models:</p>
<ul class="simple">
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">EELSCLEdge</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">VolumePlasmonDrude</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">PowerLaw</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Offset</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Exponential</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">ScalableFixedPattern</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">GaussianHF</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Lorentzian</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Voigt</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Polynomial</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Logistic</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Bleasdale</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Erf</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">SEE</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Arctan</span></code></li>
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">HeavisideStep</span></code></li>
</ul>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0: </span>The following components are currently available for
two-dimensional models:</p>
</div>
<ul class="simple">
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian2D</span></code></li>
</ul>
<p>However, this doesn’t mean that you have to limit yourself to this meagre list
of functions. A new function can easily be written or a custom function may
be specified as below.</p>
<div class="section" id="specifying-custom-components">
<h3>Specifying custom components<a class="headerlink" href="#specifying-custom-components" title="Permalink to this headline">¶</a></h3>
<div class="versionadded" id="expression-component-label">
<p><span class="versionmodified">New in version 0.8.1: </span><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code>
component</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2: </span><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code> component
can create 2D components.</p>
</div>
<p>The easiest way to turn a mathematical expression into a component is using the
<code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code> component. For example, the
following is all you need to create a <cite>Gaussian</cite> component  with more sensible
parameters for spectroscopy than the one that ships with HyperSpy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="n">expression</span><span class="o">=</span><span class="s2">&quot;height * exp(-(x - x0) ** 2 * 4 * log(2)/ fwhm ** 2)&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span><span class="n">fwhm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span><span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="gp">... </span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the expression is inconvenient to write out in full (e.g. it’s long and/or
complicated), multiple substitutions can be given, separated by semicolons.
Both symbolic and numerical substitutions are allowed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;h / sqrt(p2) ; p2 = 2 * m0 * e1 * x * brackets;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">+=</span> <span class="s2">&quot;brackets = 1 + (e1 * x) / (2 * m0 * c * c) ;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expression</span> <span class="o">+=</span> <span class="s2">&quot;m0 = 9.1e-31 ; c = 3e8; e1 = 1.6e-19 ; h = 6.6e-34&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="n">expression</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span>
<span class="gp">... </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Electron wavelength with voltage&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code> uses <a class="reference external" href="http://www.sympy.org">Sympy</a> internally to turn the string into
a funtion. By default it “translates” the expression using
numpy, but often it is possible to boost performance by using
<a class="reference external" href="https://github.com/pydata/numexpr">numexpr</a> instead.</p>
<p>It can also create 2D components with optional rotation. In the following
example we create a 2D gaussian that rotates around its center:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components2D</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
<span class="gp">... </span><span class="s2">&quot;k * exp(-((x-x0)**2 / (2 * sx ** 2) + (y-y0)**2 / (2 * sy ** 2)))&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="s2">&quot;Gaussian2d&quot;</span><span class="p">,</span> <span class="n">add_rotation</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;y0&quot;</span><span class="p">),</span>
<span class="gp">... </span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
<p>Of course <code class="xref py py-class docutils literal notranslate"><span class="pre">Expression</span></code> is only useful for
analytical functions. For more general components you need to create the
component “by hand”. The good news is that, if you know how to write the
function with Python, turning it into a component is very easy, just modify
the following template to suit your needs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hyperspy.component</span> <span class="kn">import</span> <span class="n">Component</span>

<span class="k">class</span> <span class="nc">MyComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">parameter_2</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># Define the parameters</span>
        <span class="n">Component</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;parameter_1&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter_2&#39;</span><span class="p">))</span>

        <span class="c1"># Optionally we can set the initial values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">parameter_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">parameter_1</span>

        <span class="c1"># The units (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Tesla&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Kociak&#39;</span>

        <span class="c1"># Once defined we can give default values to the attribute</span>
        <span class="c1"># For example we fix the attribure_1 (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">attribute_1</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># And we set the boundaries (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">bmax</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Optionally, to boost the optimization speed we can also define</span>
        <span class="c1"># the gradients of the function we the syntax:</span>
        <span class="c1"># self.parameter.grad = function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_parameter_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_parameter_2</span>

    <span class="c1"># Define the function as a function of the already defined parameters,</span>
    <span class="c1"># x being the independent variable value</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_1</span><span class="o">.</span><span class="n">value</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_2</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">p2</span>

    <span class="c1"># Optionally define the gradients of each parameter</span>
    <span class="k">def</span> <span class="nf">grad_parameter_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns d(function)/d(parameter_1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">grad_parameter_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns d(function)/d(parameter_2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>If you need help with the task please submit your question to the <span class="xref std std-ref">users
mailing list</span>.</p>
<div class="versionchanged" id="id1">
<p><span class="versionmodified">Changed in version 0.8.1: </span>printing current model components</p>
</div>
<p>To print the current components in a model use <code class="xref py py-attr docutils literal notranslate"><span class="pre">components</span></code>. A
table with component number, attribute name, component name and
component type will be printed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">&lt;Model, title: my signal title&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span> <span class="c1"># an empty model</span>
<span class="go">   # |       Attribute Name |       Component Name |        Component Type</span>
<span class="go">---- | -------------------- | -------------------- | ---------------------</span>
</pre></div>
</div>
<p>In fact, components may be created automatically in some cases. For example, if
the <cite>Signal1D</cite> is recognised as EELS data, a power-law background component will
automatically be placed in the model. To add a component first we have to create
an instance of the component. Once the instance has been created we can add the
component to the model using the <code class="xref py py-meth docutils literal notranslate"><span class="pre">append()</span></code> method, e.g. for a type of
data that can be modelled using gaussians we might proceed as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create a Gaussian comp.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaussian</span><span class="p">)</span> <span class="c1"># Add it to the model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span> <span class="c1"># Print the model components</span>
<span class="go">   # |       Attribute Name |        Component Name |        Component Type</span>
<span class="go">---- | -------------------- | --------------------- | ---------------------</span>
<span class="go">   0 |             Gaussian |              Gaussian |              Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create another gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span> <span class="c1"># Create a third gaussian</span>
</pre></div>
</div>
<p>We could use the append method twice to add the two gaussians, but when
adding multiple components it is handier to use the extend method that enables
adding a list of components at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">gaussian2</span><span class="p">,</span> <span class="n">gaussian3</span><span class="p">))</span> <span class="c1"># note the double brackets!</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |       Attribute Name |      Component Name |        Component Type</span>
<span class="go">---- | -------------------- | ------------------- | ---------------------</span>
<span class="go">   0 |             Gaussian |            Gaussian |              Gaussian</span>
<span class="go">   1 |           Gaussian_0 |          Gaussian_0 |              Gaussian</span>
<span class="go">   2 |           Gaussian_1 |          Gaussian_1 |              Gaussian</span>
</pre></div>
</div>
<p>We can customise the name of the components.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Carbon&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Long Hydrogen name&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Nitrogen&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |        Attribute Name |        Component Name |      Component Type</span>
<span class="go">---- | --------------------- | --------------------- | -------------------</span>
<span class="go">   0 |                Carbon |                Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |    Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |              Nitrogen |            Gaussian</span>
</pre></div>
</div>
<p>Two components cannot have the same name.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Carbon&#39;</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;ipython-input-5-2b5669fae54a&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">g2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Carbon&quot;</span>
<span class="gr">  File &quot;/home/fjd29/Python/hyperspy/hyperspy/component.py&quot;, line 466, in</span>
<span class="gr">    name &quot;the name &quot; + str(value))</span>
<span class="gr">ValueError</span>: <span class="n">Another component already has the name Carbon</span>
</pre></div>
</div>
<p>It is possible to access the components in the model by their name or by the
index in the model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">   # |        Attribute Name |       Component Name |      Component Type</span>
<span class="go">---- | --------------------- | -------------------- | -------------------</span>
<span class="go">   0 |                Carbon |               Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |   Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |             Nitrogen |            Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&lt;Carbon (Gaussian component)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;Long Hydrogen name&quot;</span><span class="p">]</span>
<span class="go">&lt;Long Hydrogen name (Gaussian component)&gt;</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.8.1: </span><code class="xref py py-attr docutils literal notranslate"><span class="pre">components</span></code> attribute</p>
</div>
<p>In addition, the components can be accessed in the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">components</span></code> <cite>Model</cite> attribute. This is specially
useful when working in interactive data analysis with IPython because it
enables tab completion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span>
<span class="go">   # |        Attribute Name |        Component Name |      Component Type</span>
<span class="go">---- | --------------------- | --------------------- | -------------------</span>
<span class="go">   0 |                Carbon |                Carbon |            Gaussian</span>
<span class="go">   1 |    Long_Hydrogen_name |    Long Hydrogen name |            Gaussian</span>
<span class="go">   2 |              Nitrogen |              Nitrogen |            Gaussian</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">Long_Hydrogen_name</span>
<span class="go">&lt;Long Hydrogen name (Gaussian component)&gt;</span>
</pre></div>
</div>
<p>It is possible to “switch off” a component by setting its
<code class="xref py py-attr docutils literal notranslate"><span class="pre">active</span></code> to <cite>False</cite>. When a component is
switched off, to all effects it is as if it was not part of the model. To
switch it on simply set the <code class="xref py py-attr docutils literal notranslate"><span class="pre">active</span></code> attribute
back to <cite>True</cite>.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.1: </span><code class="xref py py-attr docutils literal notranslate"><span class="pre">active_is_multidimensional</span></code></p>
</div>
<p>In multidimensional signals it is possible to store the value of the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">active</span></code> attribute at each navigation index.
To enable this feature for a given component set the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">active_is_multidimensional</span></code> attribute to
<cite>True</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">active_is_multidimensional</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([ True,  True,  True,  True,  True,  True,  True,  True,  True,  True], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">_active_array</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_component_active_value</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([False, False, False, False, False, False, False, False, False, False], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_component_active_value</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_current</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span>
<span class="go">array([ True, False, False, False, False, False, False, False, False, False], dtype=bool)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">active_is_multidimensional</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">_active_array</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="indexing-the-model">
<span id="model-indexing-label"></span><h2>Indexing the model<a class="headerlink" href="#indexing-the-model" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0: </span>model indexing</p>
</div>
<p>Often it is useful to consider only part of the model - for example at
a particular location (i.e. a slice in the navigation space) or energy range
(i.e. a slice in the signal space). This can be done using exactly the same
syntax that we use for signal indexing (<a class="reference internal" href="tools.html#signal-indexing"><span class="std std-ref">Indexing</span></a>).
<code class="xref py py-attr docutils literal notranslate"><span class="pre">red_chisq</span></code> and <code class="xref py py-attr docutils literal notranslate"><span class="pre">dof</span></code> are automatically
recomputed for the resulting slices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># select first three navigation pixels and last five signal channels</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">inav</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">isig</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">signal</span>
<span class="go">&lt;Signal1D, title: , dimensions: (3|5)&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-and-setting-parameter-values-and-attributes">
<h2>Getting and setting parameter values and attributes<a class="headerlink" href="#getting-and-setting-parameter-values-and-attributes" title="Permalink to this headline">¶</a></h2>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">print_current_values()</span></code> prints the value of the
parameters of the components in the current coordinates.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">parameters</span></code> contains a list of the parameters
of a component and <code class="xref py py-attr docutils literal notranslate"><span class="pre">free_parameters</span></code> lists only
the free parameters.</p>
<p>The value of a particular parameter can be accessed in the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">value</span></code>.</p>
<p>If a model contains several components with the same parameters, it is possible
to change them all by using <code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_value()</span></code>.
Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">only_current</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 40.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_value</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="n">component_list</span><span class="o">=</span><span class="p">[</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.,  30.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="go">array([ 40.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.,  20.])</span>
</pre></div>
</div>
<p>To set the the <cite>free</cite> state of a parameter change the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">free</span></code> attribute. To change the <cite>free</cite> state of
all parameters in a component to <cite>True</cite> use
<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code>, and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code> for setting them to
<cite>False</cite>. Specific parameter-names can also be specified by using
<cite>parameter_name_list</cite>, shown in the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">    &lt;Parameter sigma of Gaussian component&gt;,</span>
<span class="go">    &lt;Parameter centre of Gaussian component&gt;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">set_parameters_not_free</span><span class="p">()</span>
<span class="go">set([])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">(</span><span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;centre&#39;</span><span class="p">])</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">     &lt;Parameter centre of Gaussian component&gt;])</span>
</pre></div>
</div>
<p>Similar functions exist for <code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code>:
<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code>. Which sets the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">free</span></code> states for the parameters in components
in a model. Specific components and parameter-names can also be specified. For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_not_free</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">(</span><span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">set_parameters_free</span><span class="p">([</span><span class="n">g1</span><span class="p">],</span> <span class="n">parameter_name_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;,</span>
<span class="go">     &lt;Parameter sigma of Gaussian component&gt;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g2</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="go">set([&lt;Parameter A of Gaussian component&gt;])</span>
</pre></div>
</div>
<p>The value of a parameter can be coupled to the value of another by setting the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin</span></code> attribute.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># Print the parameters of the gaussian components</span>
<span class="go">(A, sigma, centre)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># Fix the centre</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian</span><span class="o">.</span><span class="n">free_parameters</span>  <span class="c1"># Print the free parameters</span>
<span class="go">set([A, sigma])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span> <span class="c1"># Print the current value of all free param.</span>
<span class="go">Components  Parameter       Value</span>
<span class="go">Normalized Gaussian</span>
<span class="go">        A   1.000000</span>
<span class="go">        sigma       1.000000</span>
<span class="go">Normalized Gaussian</span>
<span class="go">        centre      0.000000</span>
<span class="go">        A   1.000000</span>
<span class="go">        sigma       1.000000</span>
<span class="go">Normalized Gaussian</span>
<span class="go">        A   1.000000</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        centre      0.000000</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Couple the A parameter of gaussian2 to the A parameter of gaussian 3:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin</span> <span class="o">=</span> <span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Set the gaussian2 centre value to 10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span>
<span class="go">Components  Parameter       Value</span>
<span class="go">Carbon</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   1.000000</span>
<span class="go">        centre      0.000000</span>
<span class="go">Hydrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   10.000000</span>
<span class="go">        centre      10.000000</span>
<span class="go">Nitrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   10.000000</span>
<span class="go">        centre      0.000000</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Set the gaussian1 centre value to 5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span>
<span class="go">Components  Parameter       Value</span>
<span class="go">Carbon</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   1.000000</span>
<span class="go">        centre      0.000000</span>
<span class="go">Hydrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   5.000000</span>
<span class="go">        centre      10.000000</span>
<span class="go">Nitrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   5.000000</span>
<span class="go">        centre      0.000000</span>
</pre></div>
</div>
<div class="deprecated">
<p><span class="versionmodified">Deprecated since version 1.2.0: </span>Setting the <code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function</span></code> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function</span></code> attributes. Set the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code> attributes
instead.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2.0: </span><code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code>.</p>
</div>
<p>By default the coupling function is the identity function. However it is
possible to set a different coupling function by setting the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_function_expr</span></code> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">twin_inverse_function_expr</span></code> attributes.  For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin_function_expr</span> <span class="o">=</span> <span class="s2">&quot;x**2&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">twin_inverse_function_expr</span> <span class="o">=</span> <span class="s2">&quot;sqrt(abs(x))&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian2</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span>
<span class="go">Components  Parameter       Value</span>
<span class="go">Carbon</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   1.000000</span>
<span class="go">        centre      0.000000</span>
<span class="go">Hydrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   4.000000</span>
<span class="go">        centre      10.000000</span>
<span class="go">Nitrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   2.000000</span>
<span class="go">        centre      0.000000</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gaussian3</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span>
<span class="go">Components  Parameter       Value</span>
<span class="go">Carbon</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   1.000000</span>
<span class="go">        centre      0.000000</span>
<span class="go">Hydrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   16.000000</span>
<span class="go">        centre      10.000000</span>
<span class="go">Nitrogen</span>
<span class="go">        sigma       1.000000</span>
<span class="go">        A   4.000000</span>
<span class="go">        centre      0.000000</span>
</pre></div>
</div>
</div>
<div class="section" id="fitting-the-model-to-the-data">
<span id="id2"></span><h2>Fitting the model to the data<a class="headerlink" href="#fitting-the-model-to-the-data" title="Permalink to this headline">¶</a></h2>
<p>To fit the model to the data at the current coordinates (e.g. to fit one
spectrum at a particular point in a spectrum-image) use
<code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code>.</p>
<p>The following table summarizes the features of the currently available
optimizers. For more information on the local and global optimization
algorithms, see the
<a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/optimize.html">Scipy documentation</a>.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1: </span>Global optimizer <cite>Differential Evolution</cite> added.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.1: </span><cite>leastsq</cite> supports bound constraints. <cite>fmin_XXX</cite>
methods changed to the <cite>scipy.optimze.minimize()</cite> notation.</p>
</div>
<span id="optimizers-table"></span><table border="1" class="docutils" id="id3">
<caption><span class="caption-text">Features of curve fitting optimizers.</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="36%" />
<col width="11%" />
<col width="25%" />
<col width="17%" />
<col width="11%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Optimizer</th>
<th class="head">Bounds</th>
<th class="head">Error estimation</th>
<th class="head">Method</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>“leastsq”</td>
<td>Yes</td>
<td>Yes</td>
<td>‘ls’</td>
<td>local</td>
</tr>
<tr class="row-odd"><td>“mpfit”</td>
<td>Yes</td>
<td>Yes</td>
<td>‘ls’</td>
<td>local</td>
</tr>
<tr class="row-even"><td>“odr”</td>
<td>No</td>
<td>Yes</td>
<td>‘ls’</td>
<td>local</td>
</tr>
<tr class="row-odd"><td>“Nelder-Mead”</td>
<td>No</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-even"><td>“Powell”</td>
<td>No</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-odd"><td>“CG”</td>
<td>No</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-even"><td>“BFGS”</td>
<td>No</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-odd"><td>“Newton-CG”</td>
<td>No</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-even"><td>“L-BFGS-B”</td>
<td>Yes</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-odd"><td>“TNC”</td>
<td>Yes</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>local</td>
</tr>
<tr class="row-even"><td>“Differential Evolution”</td>
<td>Yes</td>
<td>No</td>
<td>‘ls’, ‘ml’</td>
<td>global</td>
</tr>
</tbody>
</table>
<p>The following example shows how to perfom least squares with error estimation.</p>
<p>First we create data consisting of a line line <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">a*x</span> <span class="pre">+</span> <span class="pre">b</span></code> with <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">1</span></code>
and <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">=</span> <span class="pre">100</span></code> and we add white noise to it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">add_gaussian_noise</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>To fit it we create a model consisting of a
<code class="xref py py-class docutils literal notranslate"><span class="pre">Polynomial</span></code> component of order 1 and fit it
to the data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>On fitting completion, the optimized value of the parameters and their
estimated standard deviation are stored in the following line attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(0.99246156488437653, 103.67507406125888)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">std</span>
<span class="go">(0.11771053738516088, 13.541061301257537)</span>
</pre></div>
</div>
<p>When the noise is heterocedastic, only if the
<code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code> attribute of the
<code class="xref py py-class docutils literal notranslate"><span class="pre">Signal1D</span></code> instance is defined can the errors be
estimated accurately. If the variance is not defined, the standard deviation of
the parameters are still computed and stored in the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">std</span></code> attribute by setting variance equal 1.
However, the value won’t be correct unless an accurate value of the variance is
defined in <code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code>. See
<a class="reference internal" href="tools.html#signal-noise-properties"><span class="std std-ref">Setting the noise properties</span></a> for more information.</p>
<p>In the following example, we add poissonian noise to the data instead of
gaussian noise and proceed to fit as in the previous example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">add_poissonian_noise</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span>  <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0052331707848698, -1.0723588390873573)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">std</span>
<span class="go">(0.0081710549764721901, 1.4117294994070277)</span>
</pre></div>
</div>
<p>Because the noise is heterocedastic, the least squares optimizer estimation is
biased. A more accurate result can be obtained by using weighted least squares
instead that, although still biased for poissonian noise, is a good
approximation in most cases.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">estimate_poissonian_noise_variance</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">expected_value</span><span class="o">=</span><span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">Signal1D</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0004224896604759, -0.46982916592391377)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">std</span>
<span class="go">(0.0055752036447948173, 0.46950832982673557)</span>
</pre></div>
</div>
<p>We can use Poisson maximum likelihood estimation
instead, which is an unbiased estimator for poissonian noise.
To do so, we use a general optimizer called “Nelder-Mead”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fitter</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ml&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span><span class="o">.</span><span class="n">coefficients</span><span class="o">.</span><span class="n">value</span>
<span class="go">(1.0030718094185611, -0.63590210946134107)</span>
</pre></div>
</div>
<p>Problems of ill-conditioning and divergence can be ameliorated by using bounded
optimization. Currently, not all optimizers support bounds - see the
<a class="reference internal" href="#optimizers-table"><span class="std std-ref">table above</span></a>. In the following example a gaussian
histogram is fitted using a <code class="xref py py-class docutils literal notranslate"><span class="pre">Gaussian</span></code>
component using mpfit and bounds on the <code class="docutils literal notranslate"><span class="pre">centre</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">BaseSignal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span><span class="n">size</span><span class="o">=</span><span class="mf">1e5</span><span class="p">))</span><span class="o">.</span><span class="n">get_histogram</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">Signal</span><span class="o">.</span><span class="n">binned</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="mi">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">bmax</span> <span class="o">=</span> <span class="mi">14</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g1</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">bounded</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fitter</span><span class="o">=</span><span class="s2">&quot;mpfit&quot;</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">print_current_values</span><span class="p">()</span>
<span class="go">Components  Parameter   Value</span>
<span class="go">Gaussian</span>
<span class="go">        sigma   0.00996345</span>
<span class="go">        A   99918.7</span>
<span class="go">        centre  9.99976</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7: </span>chi-squared and reduced chi-squared</p>
</div>
<p>The chi-squared, reduced chi-squared and the degrees of freedom are
computed automatically when fitting. They are stored as signals, in the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">chisq</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">red_chisq</span></code>  and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">dof</span></code> attributes of the model respectively. Note that,
unless <code class="docutils literal notranslate"><span class="pre">metadata.Signal.Noise_properties.variance</span></code> contains an accurate
estimation of the variance of the data, the chi-squared and reduced
chi-squared cannot be computed correctly. This is also true for
homocedastic noise.</p>
<div class="section" id="visualizing-the-model">
<span id="model-visualization"></span><h3>Visualizing the model<a class="headerlink" href="#visualizing-the-model" title="Permalink to this headline">¶</a></h3>
<p>To visualise the result use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># Visualise the results</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.</span></p>
</div>
<p>By default only the full model line is displayed in the plot. In addition, it
is possible to display the individual components by calling
<code class="xref py py-meth docutils literal notranslate"><span class="pre">enable_plot_components()</span></code> or directly using
<code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_components</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># Visualise the results</span>
</pre></div>
</div>
<p>To disable this feature call
<code class="xref py py-meth docutils literal notranslate"><span class="pre">disable_plot_components()</span></code>.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.1: </span><code class="xref py py-meth docutils literal notranslate"><span class="pre">suspend_update()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">resume_update()</span></code></p>
</div>
<p>By default the model plot is automatically updated when any parameter value
changes. It is possible to suspend this feature with
<code class="xref py py-meth docutils literal notranslate"><span class="pre">suspend_update()</span></code>. To resume it use
<code class="xref py py-meth docutils literal notranslate"><span class="pre">resume_update()</span></code>.</p>
</div>
<div class="section" id="setting-the-initial-parameters">
<span id="model-starting"></span><h3>Setting the initial parameters<a class="headerlink" href="#setting-the-initial-parameters" title="Permalink to this headline">¶</a></h3>
<p>Non-linear regression often requires setting sensible starting
parameters. This can be done by plotting the model and adjusting the parameters
by hand.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7: </span>In addition, it is possible to fit a given component  independently using
the <code class="xref py py-meth docutils literal notranslate"><span class="pre">fit_component()</span></code> method.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.8.5: </span><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code>,</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3: </span>All <code class="xref py py-meth docutils literal notranslate"><span class="pre">notebook_interaction()</span></code> methods renamed to <code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code>. The
<code class="xref py py-meth docutils literal notranslate"><span class="pre">notebook_interaction()</span></code> methods will be removed in 2.0</p>
</div>
<p id="notebook-interaction-label">If running in a Jupyter Notebook, interactive widgets can be used to
conveniently adjust the parameter values by running
<code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code> for <code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code>.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../_images/notebook_widgets.png"><img alt="../_images/notebook_widgets.png" src="../_images/notebook_widgets.png" style="width: 985px;" /></a>
<p class="caption"><span class="caption-text">Interactive widgets for the full model in a Jupyter notebook. Drag the
sliders to adjust current parameter values. Typing different minimum and
maximum values changes the boundaries of the slider.</span></p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.6: </span><code class="xref py py-meth docutils literal notranslate"><span class="pre">enable_adjust_position()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">disable_adjust_position()</span></code></p>
</div>
<p>Also, <code class="xref py py-meth docutils literal notranslate"><span class="pre">enable_adjust_position()</span></code> provides an
interactive way of setting the position of the components with a
well-defined position.
<code class="xref py py-meth docutils literal notranslate"><span class="pre">disable_adjust_position()</span></code> disables the tool.</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../_images/model_adjust_position.png"><img alt="../_images/model_adjust_position.png" src="../_images/model_adjust_position.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text">Interactive component position adjustment tool. Drag the vertical lines
to set the initial value of the position parameter.</span></p>
</div>
</div>
<div class="section" id="exclude-data-from-the-fitting-process">
<h3>Exclude data from the fitting process<a class="headerlink" href="#exclude-data-from-the-fitting-process" title="Permalink to this headline">¶</a></h3>
<p>The following <code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code> methods can be used to exclude
undesired spectral channels from the fitting process:</p>
<ul class="simple">
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_signal_range()</span></code></li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">remove_signal_range()</span></code></li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">reset_signal_range()</span></code></li>
</ul>
</div>
<div class="section" id="fitting-multidimensional-datasets">
<h3>Fitting multidimensional datasets<a class="headerlink" href="#fitting-multidimensional-datasets" title="Permalink to this headline">¶</a></h3>
<p>To fit the model to all the elements of a multidimensional datataset use
<code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code>, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">multifit</span><span class="p">()</span> <span class="c1"># warning: this can be a lengthy process on large datasets</span>
</pre></div>
</div>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">multifit()</span></code> fits the model at the first position,
store the result of the fit internally and move to the next position until
reaching the end of the dataset.</p>
<p>Sometimes one may like to store and fetch the value of the parameters at a
given position manually. This is possible using
<code class="xref py py-meth docutils literal notranslate"><span class="pre">store_current_values()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">fetch_stored_values()</span></code>.</p>
</div>
<div class="section" id="visualising-the-result-of-the-fit">
<h3>Visualising the result of the fit<a class="headerlink" href="#visualising-the-result-of-the-fit" title="Permalink to this headline">¶</a></h3>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">plot_results()</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code> methods
can be used to visualise the result of the fit <strong>when fitting multidimensional
datasets</strong>.</p>
</div>
</div>
<div class="section" id="storing-models">
<span id="storing-models-label"></span><h2>Storing models<a class="headerlink" href="#storing-models" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0: </span><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelManager</span></code></p>
</div>
<p>Multiple models can be stored in the same signal. In particular, when
<code class="xref py py-meth docutils literal notranslate"><span class="pre">store()</span></code> is called, a full “frozen” copy of the model is stored
in <code class="xref py py-attr docutils literal notranslate"><span class="pre">models</span></code>. The stored models can be recreated at any time
by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">restore()</span></code> with the stored model name as an
argument. To remove a model from storage, simply call
<code class="xref py py-meth docutils literal notranslate"><span class="pre">remove()</span></code></p>
<p>The stored models can be either given a name, or assigned one automatically.
The automatic naming follows alphabetical scheme, with the sequence being (a,
b, …, z, aa, ab, …, az, ba, …).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to slice a model, you have to perform the operation on the
model itself, not its stored version</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Modifying a signal in-place (e.g. <code class="xref py py-meth docutils literal notranslate"><span class="pre">map()</span></code>,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">crop()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">align1D()</span></code>,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">align2D()</span></code> and similar) will invalidate all stored models.
This is done intentionally.</p>
</div>
<p>Current stored models can be listed by calling <code class="xref py py-attr docutils literal notranslate"><span class="pre">models</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Lorentzian</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s1">&#39;myname&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">models</span>
<span class="go">└── myname</span>
<span class="go">    ├── components</span>
<span class="go">    │   └── Lorentzian</span>
<span class="go">    ├── date = 2015-09-07 12:01:50</span>
<span class="go">    └── dimensions = (|100)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">components1D</span><span class="o">.</span><span class="n">Exponential</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="c1"># assign model name automatically</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">models</span>
<span class="go">├── a</span>
<span class="go">│   ├── components</span>
<span class="go">│   │   ├── Exponential</span>
<span class="go">│   │   └── Lorentzian</span>
<span class="go">│   ├── date = 2015-09-07 12:01:57</span>
<span class="go">│   └── dimensions = (|100)</span>
<span class="go">└── myname</span>
<span class="go">    ├── components</span>
<span class="go">    │   └── Lorentzian</span>
<span class="go">    ├── date = 2015-09-07 12:01:50</span>
<span class="go">    └── dimensions = (|100)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;myname&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">components</span>
<span class="go">   # |      Attribute Name |       Component Name |       Component Type</span>
<span class="go">---- | ------------------- | -------------------- | --------------------</span>
<span class="go">   0 |          Lorentzian |           Lorentzian |           Lorentzian</span>
</pre></div>
</div>
<div class="section" id="saving-and-loading-the-result-of-the-fit">
<h3>Saving and loading the result of the fit<a class="headerlink" href="#saving-and-loading-the-result-of-the-fit" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0.</span></p>
</div>
<p>To save a model, a convenience function <code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code> is provided,
which stores the current model into its signal and saves the signal. As
described in <span class="xref std std-ref">storing_models</span>, more than just one model can be saved with
one signal.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># analysis and fitting goes here</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;my_filename&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;my_filename.hspy&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="c1"># or l.models.model_name.restore()</span>
</pre></div>
</div>
<p>For older versions of HyperSpy (before 0.9), the instructions were as follows:</p>
<blockquote>
<div><p>Note that this method is known to be brittle i.e. there is no
guarantee that a version of HyperSpy different from the one used to save
the model will be able to load it successfully.  Also, it is
advisable not to use this method in combination with functions that
alter the value of the parameters interactively (e.g.
<cite>enable_adjust_position</cite>) as the modifications made by this functions
are normally not stored in the IPython notebook or Python script.</p>
<p>To save a model:</p>
<ol class="arabic simple">
<li>Save the parameter arrays to a file using
<code class="xref py py-meth docutils literal notranslate"><span class="pre">save_parameters2file()</span></code>.</li>
<li>Save all the commands that used to create the model to a file. This
can be done in the form of an IPython notebook or a Python script.</li>
<li>(Optional) Comment out or delete the fitting commands (e.g.
<code class="docutils literal notranslate"><span class="pre">multifit</span></code>).</li>
</ol>
<p>To recreate the model:</p>
<ol class="arabic simple">
<li>Execute the IPython notebook or Python script.</li>
<li>Use <code class="xref py py-meth docutils literal notranslate"><span class="pre">load_parameters_from_file()</span></code> to load
back the parameter values and arrays.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="exporting-the-result-of-the-fit">
<h3>Exporting the result of the fit<a class="headerlink" href="#exporting-the-result-of-the-fit" title="Permalink to this headline">¶</a></h3>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">BaseModel</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">export_results()</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">export()</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">Parameter</span></code> <code class="xref py py-meth docutils literal notranslate"><span class="pre">export()</span></code>
methods can be used to export the result of the optimization in all supported
formats.</p>
</div>
</div>
<div class="section" id="batch-setting-of-parameter-attributes">
<h2>Batch setting of parameter attributes<a class="headerlink" href="#batch-setting-of-parameter-attributes" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.6.</span></p>
</div>
<p>The following methods can be used to ease the task of setting some important
parameter attributes:</p>
<ul class="simple">
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_not_free()</span></code></li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_free()</span></code></li>
<li><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_parameters_value()</span></code></li>
</ul>
</div>
<div class="section" id="smart-adaptive-multi-dimensional-fitting-samfire">
<span id="samfire-label"></span><h2>Smart Adaptive Multi-dimensional Fitting (SAMFire)<a class="headerlink" href="#smart-adaptive-multi-dimensional-fitting-samfire" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0: </span>SAMFire</p>
</div>
<p>SAMFire (Smart Adaptive Multi-dimensional Fitting) is an algorithm created to
reduce the starting value (or local / false minima) problem, which often arises
when fitting multi-dimensional datasets.</p>
<p>The algorithm will be described in full when accompanying paper is published,
but we are making the implementation available now, with additional details
available in the following <a class="reference external" href="https://doi.org/10.1002/9783527808465.EMC2016.6233">conference proceeding</a>.</p>
<div class="section" id="the-idea">
<h3>The idea<a class="headerlink" href="#the-idea" title="Permalink to this headline">¶</a></h3>
<p>The main idea of SAMFire is to change two things compared to the traditional
way of fitting datasets with many dimensions in the navigation space:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Pick a more sensible pixel fitting order.</li>
<li>Calculate the pixel starting parameters from already fitted parts of the
dataset.</li>
</ol>
</div></blockquote>
<p>Both of these aspects are linked one to another and are represented by two
different strategy families that SAMFfire uses while operating.</p>
</div>
<div class="section" id="strategies">
<h3>Strategies<a class="headerlink" href="#strategies" title="Permalink to this headline">¶</a></h3>
<p>During operation SAMFire uses a list of strategies to determine how to select
the next pixel and estimate its starting parameters. Only one strategy is used
at a time. Next strategy is chosen when no new pixels are can be fitted with
the current strategy. Once either the strategy list is exhausted or the full
dataset fitted, the algorithm terminates.</p>
<p>There are two families of strategies. In each family there may be many
strategies, using different statistical or significance measures.</p>
<p>As a rule of thumb, the first strategy in the list should always be from the
local family, followed by a strategy from the global family.</p>
</div>
<div class="section" id="local-strategy-family">
<h3>Local strategy family<a class="headerlink" href="#local-strategy-family" title="Permalink to this headline">¶</a></h3>
<p>These strategies assume that locally neighbouring pixels are similar. As a
result, the pixel fitting order seems to follow data-suggested order, and the
starting values are computed from the surrounding already fitted pixels.</p>
<p>More information about the exact procedure will be available once the
accompanying paper is published.</p>
</div>
<div class="section" id="global-strategy-family">
<h3>Global strategy family<a class="headerlink" href="#global-strategy-family" title="Permalink to this headline">¶</a></h3>
<p>Global strategies assume that the navigation coordinates of each pixel bear no
relation to it’s signal (i.e. the location of pixels is meaningless). As a
result, the pixels are selected at random to ensure uniform sampling of the
navigation space.</p>
<p>A number of candidate starting values are computed form global statistical
measures. These values are all attempted in order until a satisfactory result
is found (not necessarily testing all available starting guesses). As a result,
on average each pixel requires significantly more computations when compared to
a local strategy.</p>
<p>More information about the exact procedure will be available once the
accompanying paper is published.</p>
</div>
<div class="section" id="seed-points">
<h3>Seed points<a class="headerlink" href="#seed-points" title="Permalink to this headline">¶</a></h3>
<p>Due to the strategies using already fitted pixels to estimate the starting
values, at least one pixel has to be fitted beforehand by the user.</p>
<p>The seed pixel(s) should be selected to require the most complex model present
in the dataset, however in-built goodness of fit checks ensure that only
sufficiently well fitted values are allowed to propagate.</p>
<p>If the dataset consists of regions (in the navigation space) of highly
dissimilar pixels, often called “domain structures”, at least one seed pixel
should be given for each unique region.</p>
<p>If the starting pixels were not optimal, only part of the dataset will be
fitted. In such cases it is best to allow the algorithm terminate, then provide
new (better) seed pixels by hand, and restart SAMFire. It will use the
new seed together with the already computed parts of the data.</p>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>After creating a model and fitting suitable seed pixels, to fit the rest of
the multi-dimensional dataset using SAMFire we must craete a SAMFire instance
as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">create_samfire</span><span class="p">(</span><span class="n">workers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ipyparallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>By default SAMFire will look for an <a class="reference external" href="http://ipyparallel.readthedocs.io/en/latest/index.html">ipyparallel</a> cluster for the
workers for around 30 seconds. If none is available, it will use
multiprocessing instead.  However, if you are not planning to use ipyparallel,
it’s recommended specify it explicitly via the <code class="docutils literal notranslate"><span class="pre">ipyparallel=False</span></code> argument,
to use the fall-back option of <cite>multiprocessing</cite>.</p>
<p>By default a new SAMFire object already has two (and currently only) strategies
added to its strategist list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">strategies</span>
<span class="go">  A |    # | Strategy</span>
<span class="go"> -- | ---- | -------------------------</span>
<span class="go">  x |    0 | Reduced chi squared strategy</span>
<span class="go">    |    1 | Histogram global strategy</span>
</pre></div>
</div>
<p>The currently active strategy is marked by an ‘x’ in the first column.</p>
<p>If a new datapoint (i.e. pixel) is added manually, the “database” of the
currently active strategy has to be refreshed using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">refresh_database()</span></code> call.</p>
<p>The current strategy “database” can be plotted using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">plot()</span></code> method.</p>
<p>Whilst SAMFire is running, each pixel is checked by a <code class="docutils literal notranslate"><span class="pre">goodness_test</span></code>,
which is by default <code class="xref py py-class docutils literal notranslate"><span class="pre">red_chisq_test</span></code>, checking the
reduced chi-squared to be in the bounds of [0, 2].</p>
<p>This tolerance can (and most likely should!) be changed appropriately for the
data as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">goodness_test</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># use a sensible value</span>
</pre></div>
</div>
<p>The SAMFire managed multi-dimensional fit can be started using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">start()</span></code> method. All keyword arguments are passed to
the underlying (i.e. usual) <code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code> call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">samf</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">fitter</span><span class="o">=</span><span class="s1">&#39;mpfit&#39;</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="eels.html" class="btn btn-neutral float-right" title="Electron Energy Loss Spectroscopy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mva.html" class="btn btn-neutral" title="Machine learning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011-2018, The HyperSpy development team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.3.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/copybutton.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>
