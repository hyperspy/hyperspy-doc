
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../_static/hyperspy.ico" rel="icon" type="image/x-icon">
    <title>Running and writing tests &#8212; HyperSpy 2.0.2.dev103+gde16955a9 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom-styles.css?v=eff58afb" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=05937998"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-B0XD0GTW1M"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-B0XD0GTW1M');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-B0XD0GTW1M');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'dev_guide/testing';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://hyperspy.org/hyperspy-doc/dev/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing documentation" href="writing_docs.html" />
    <link rel="prev" title="Using Git and GitHub" href="git.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">HyperSpy API has changed in version 2.0, see the <a href='https://hyperspy.org/hyperspy-doc/current/changes.html#changes-2-0'>release notes!</a></div>
  </div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/hyperspy_logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/hyperspy_logo.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">HyperSpy</p>
  
</a></div>
    
      <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../help.html">
                        Get Help
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../changes.html">
                        Release Notes
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Contribute
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/hyperspy/hyperspy-demos">
                    Tutorial
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/hyperspy/hyperspy" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitter.im/hyperspy/hyperspy" title="Gitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Gitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://hyperspy.org" title="HyperSpy" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/hyperspy.ico" class="icon-link-image" alt="HyperSpy"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../auto_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../help.html">
                        Get Help
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../changes.html">
                        Release Notes
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Contribute
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/hyperspy/hyperspy-demos">
                    Tutorial
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/hyperspy/hyperspy" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitter.im/hyperspy/hyperspy" title="Gitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitter fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Gitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://hyperspy.org" title="HyperSpy" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/hyperspy.ico" class="icon-link-image" alt="HyperSpy"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing Guide</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">Using Git and GitHub</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Running and writing tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_docs.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_style.html">Coding style</a></li>


<li class="toctree-l1"><a class="reference internal" href="lazy_computations.html">Tips for writing methods that work on lazy signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting.html">Interactive Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="speeding_up_code.html">Speeding up code</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_extensions.html">Writing packages that extend HyperSpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="useful_information.html">Useful information</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance.html">Maintenance</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Contribute</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Running and...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="running-and-writing-tests">
<span id="testing-label"></span><h1>Running and writing tests<a class="headerlink" href="#running-and-writing-tests" title="Link to this heading">#</a></h1>
<section id="writing-tests">
<h2>Writing tests<a class="headerlink" href="#writing-tests" title="Link to this heading">#</a></h2>
<p>Every new function that is written in to HyperSpy should be tested and
documented. HyperSpy uses the <a class="reference external" href="http://doc.pytest.org/">pytest</a> library
for testing. The tests reside in the <code class="docutils literal notranslate"><span class="pre">hyperspy.tests</span></code> module.</p>
<p>Tests are short functions, found in <code class="docutils literal notranslate"><span class="pre">hyperspy/tests</span></code>, that call your functions
under some known conditions and check the outputs against known values. They
should depend on as few other features as possible so that when they break,
we know exactly what caused it. Ideally, the tests should be written at the
same time as the code itself, as they are very convenient to run to check
outputs when coding. Writing tests can seem laborious but you’ll probably
soon find that they are very important, as they force you to sanity-check
all the work that you do.</p>
<p><strong>Useful testing hints:</strong></p>
<ul>
<li><p>When comparing integers, it’s fine to use <code class="docutils literal notranslate"><span class="pre">==</span></code></p></li>
<li><p>When comparing floats, be sure to use <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_allclose.html#numpy.testing.assert_allclose" title="(in NumPy v1.26)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.testing.assert_allclose()</span></code></a>
or <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_almost_equal.html#numpy.testing.assert_almost_equal" title="(in NumPy v1.26)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.testing.assert_almost_equal()</span></code></a></p></li>
<li><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_allclose.html#numpy.testing.assert_allclose" title="(in NumPy v1.26)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.testing.assert_allclose()</span></code></a> is also convenient for comparing
numpy arrays</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">hyperspy.misc.test_utils.py</span></code> contains a few useful functions for
testing</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize()</span></code> is a very convenient decorator to test several
parameters of the same function without having to write to much repetitive
code, which is often error-prone. See <a class="reference external" href="http://doc.pytest.org/en/latest/parametrize.html">pytest documentation</a> for more details.</p></li>
<li><p>It is good to check that the tests do not use too much memory after
creating new tests. If you need to explicitly delete your objects and free
memory, you can do the following to release the memory associated with the
<code class="docutils literal notranslate"><span class="pre">s</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">gc</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Do some work with the object</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="o">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Clear the memory</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">s</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> 
</pre></div>
</div>
</li>
</ul>
</section>
<section id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Link to this heading">#</a></h2>
<p>First ensure pytest and its plugins are installed by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># If using a standard hyperspy install</span>
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>hyperspy<span class="o">[</span>tests<span class="o">]</span>

<span class="c1"># Or, from a hyperspy local development directory</span>
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="o">[</span>tests<span class="o">]</span>

<span class="c1"># Or just installing the dependencies using conda</span>
$<span class="w"> </span>conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>pytest<span class="w"> </span>pytest-mpl
</pre></div>
</div>
<p>To run them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>--mpl<span class="w"> </span>--pyargs<span class="w"> </span>hyperspy
</pre></div>
</div>
<p>Or, from HyperSpy’s project folder, simply:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>pytest configuration options are set in the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> file, under the
<code class="docutils literal notranslate"><span class="pre">[tool:pytest]</span></code> section. See the <a class="reference external" href="https://docs.pytest.org/en/latest/customize.html">pytest configuration documentation</a> for more details.</p>
</div>
<p>The HyperSpy test suite can also be run in parallel if you have multiple CPUs
available, using the <a class="reference external" href="https://pypi.org/project/pytest-xdist/">pytest-xdist plugin</a>.
If you have the plugin installed, HyperSpy will automatically run the test suite in
parallel on your machine.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To run on all the cores of your machine</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadfile

<span class="c1"># To run on 2 cores</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span>--dist<span class="w"> </span>loadfile
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--dist</span> <span class="pre">loadfile</span></code> argument will group tests by their containing file. The
groups are then distributed to available workers as whole units, thus guaranteeing
that all tests in a file run in the same worker.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running tests in parallel using <code class="docutils literal notranslate"><span class="pre">pytest-xdist</span></code> will change the content
and format of the output of <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to the console. We recommend installing
<a class="reference external" href="https://pypi.org/project/pytest-sugar/">pytest-sugar</a> to produce
nicer-looking output including an animated progressbar.</p>
</div>
<p>To test docstring examples, assuming the current location is the HyperSpy root
directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># All</span>
$<span class="w"> </span>pytest<span class="w"> </span>--doctest-modules<span class="w"> </span>--ignore-glob<span class="o">=</span>hyperspy/tests<span class="w"> </span>--pyargs<span class="w"> </span>hyperspy

<span class="c1"># In a single file, like the signal.py file</span>
$<span class="w"> </span>pytest<span class="w"> </span>--doctest-modules<span class="w"> </span>hyperspy/signal.py
</pre></div>
</div>
</section>
<section id="flaky-tests">
<h2>Flaky tests<a class="headerlink" href="#flaky-tests" title="Link to this heading">#</a></h2>
<p>Test functions can sometimes exhibit intermittent or sporadic failure, with seemingly
random or non-deterministic behaviour. They may sometimes pass or sometimes fail, and
it won’t always be clear why. These are usually known as “flaky” tests.</p>
<p>One way to approach flaky tests is to rerun them, to see if the failure was a one-off.
This can be achieved using the <a class="reference external" href="https://pypi.org/project/pytest-rerunfailures/">pytest-rerunfailures plugin</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To re-run all test suite failures a maximum of 3 times</span>
$<span class="w"> </span>pytest<span class="w"> </span>--reruns<span class="w"> </span><span class="m">3</span>

<span class="c1"># To wait 1 second before the next retry</span>
$<span class="w"> </span>pytest<span class="w"> </span>--reruns<span class="w"> </span><span class="m">3</span><span class="w"> </span>--reruns-delay<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>You can read more about flaky tests in the <a class="reference external" href="https://docs.pytest.org/en/stable/flaky.html">pytest documentation</a>.</p>
</section>
<section id="test-coverage">
<h2>Test coverage<a class="headerlink" href="#test-coverage" title="Link to this heading">#</a></h2>
<p>Once you have pushed your pull request to the official HyperSpy repository,
you can see the coverage of your tests using the
<a class="reference external" href="https://codecov.io/gh/hyperspy/hyperspy">codecov.io</a> check for
your PR. There should be a link to it at the bottom of your PR on the Github
PR page. This service can help you to find how well your code is being tested
and exactly which parts are not currently tested.</p>
<p>You can also measure code coverage locally. If you have installed <code class="docutils literal notranslate"><span class="pre">pytest-cov</span></code>,
you can run (from HyperSpy’s project folder):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>hyperspy
</pre></div>
</div>
<p>Configuration options for code coverage are also set in the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> file,
under the <code class="docutils literal notranslate"><span class="pre">[coverage:run]</span></code> and <code class="docutils literal notranslate"><span class="pre">[coverage:report]</span></code> sections. See the <a class="reference external" href="https://coverage.readthedocs.io/en/coverage-5.1/config.html">coverage
documentation</a>
for more details.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://codecov.io/gh/hyperspy/hyperspy">codecov.io</a> check in your
PR will fail if it either decreases the overall test coverage of HyperSpy,
or if any of the lines introduced in your diff are not covered.</p>
</div>
</section>
<section id="continuous-integration-ci">
<h2>Continuous integration (CI)<a class="headerlink" href="#continuous-integration-ci" title="Link to this heading">#</a></h2>
<p>The HyperSpy test suite is run using continuous integration services provided by
<a class="reference external" href="https://github.com/hyperspy/hyperspy/actions">Github Actions</a> and
<a class="reference external" href="https://dev.azure.com/franciscode-la-pena-manchon/hyperspy/_build">Azure Pipelines</a>.
In case of Azure Pipelines, CI helper scripts are pulled from the
<a class="reference external" href="https://github.com/hyperspy/ci-scripts">ci-scripts</a> repository.</p>
<p>The testing matrix is as follows:</p>
<ul class="simple">
<li><p><strong>Github Actions</strong>: test a range of Python versions on Linux, MacOS and Windows;
all dependencies are installed from <a class="reference external" href="https://pypi.org">PyPI</a>.
See <code class="docutils literal notranslate"><span class="pre">.github/workflows/tests.yml</span></code> in the HyperSpy repository for further details.</p></li>
<li><p><strong>Azure Pipeline</strong>: test a range of Python versions on Linux, MacOS and Windows;
all dependencies are installed from <a class="reference external" href="https://anaconda.org/">Anaconda Cloud</a>
using the <a class="reference external" href="https://anaconda.org/conda-forge">“conda-forge”</a> channel.
See <code class="docutils literal notranslate"><span class="pre">azure-pipelines.yml</span></code> in the HyperSpy repository for further details.</p></li>
<li><p>The testing of <strong>HyperSpy extensions</strong> is described in the
<a class="reference internal" href="writing_extensions.html#integration-test-suite-label"><span class="std std-ref">integration test suite</span></a> section.</p></li>
</ul>
<p>This testing matrix has been designed to be simple and easy to maintain, whilst
ensuring that packages from PyPI and Anaconda cloud are not mixed in order to
avoid red herring failures of the test suite caused by application binary
interface (ABI) incompatibility between dependencies.</p>
<p>The most recent versions of packages are usually available first on PyPI, before
they are available on Anaconda Cloud. These means that if a recent release of a
dependency breaks the test suite, it should happen first on Github Actions.
Similarly, deprecation warnings will usually appear first on Github Actions.</p>
<p>The documentation build is done on both Github Actions and
<a class="reference external" href="https://readthedocs.org/">Read the Docs</a>, and it is worth checking that no new
warnings have been introduced when writing documentation in the user guide or
in the docstrings.</p>
<p>The Github Actions testing matrix also includes the following special cases:</p>
<ul class="simple">
<li><p>The test suite is run against HyperSpy’s minimum requirements on Python 3.7
on Linux. This will skip any tests that require <strong>optional</strong> packages such as
<code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>.</p></li>
<li><p>The test suite is run against the oldest supported versions of <code class="docutils literal notranslate"><span class="pre">numpy</span></code>,
<code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">scipy</span></code>. For more details, see this
<a class="reference external" href="https://github.com/hyperspy/hyperspy/pull/2485">Github issue</a>.</p></li>
<li><p>The test suite is run against the development supported versions of <code class="docutils literal notranslate"><span class="pre">numpy</span></code>,
<code class="docutils literal notranslate"><span class="pre">scipy</span></code>, <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> and <code class="docutils literal notranslate"><span class="pre">scikit-image</span></code> using the weekly build wheels
available on <a class="reference external" href="https://anaconda.org/scipy-wheels-nightly">https://anaconda.org/scipy-wheels-nightly</a>. For more details, see
this <a class="reference external" href="https://github.com/hyperspy/hyperspy/pull/2616">Github issue</a>.</p></li>
</ul>
</section>
<section id="plot-testing">
<span id="plot-test-label"></span><h2>Plot testing<a class="headerlink" href="#plot-testing" title="Link to this heading">#</a></h2>
<p>Plotting is tested using the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator of
the <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest mpl plugin</a>.  This
decorator uses reference images to compare with the generated output during the
tests. The reference images are located in the folder defined by the argument
<code class="docutils literal notranslate"><span class="pre">baseline_dir</span></code> of the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator.</p>
<p>To run plot tests, you simply need to add the option <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>--mpl
</pre></div>
</div>
<p>If you don’t use <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>, the test functions will be executed, but the
images will not be compared to the reference images.</p>
<p>If you need to add or change some plots, follow the workflow below:</p>
<ol class="arabic simple">
<li><p>Write the tests using appropriate decorators such as
<code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code>.</p></li>
<li><p>If you need to generate a new reference image in the folder
<code class="docutils literal notranslate"><span class="pre">plot_test_dir</span></code>, for example, run: <code class="docutils literal notranslate"><span class="pre">pytest</span>
<span class="pre">--mpl-generate-path=plot_test_dir</span></code></p></li>
<li><p>Run again the tests and this time they should pass.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> to put the new file in the git repository.</p></li>
</ol>
<p>When the plotting tests fail, it is possible to download the figure
comparison images generated by <code class="docutils literal notranslate"><span class="pre">pytest-mpl</span></code> in the artifacts tabs of the
corresponding build on Azure Pipeliness:</p>
<figure class="align-default">
<img alt="../_images/azure_pipeline_artifacts.png" src="../_images/azure_pipeline_artifacts.png" />
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To generate the baseline images, the version of matplotlib defined in
<a class="reference external" href="https://github.com/hyperspy/hyperspy/blob/RELEASE_next_minor/conda_environment_dev.yml">conda_environment_dev.yml</a>
is required.</p>
</div>
<p>The plotting tests are tested on Azure Pipelines against a specific version of
matplotlib defined in <a class="reference external" href="https://github.com/hyperspy/hyperspy/blob/RELEASE_next_minor/conda_environment_dev.yml">conda_environment_dev.yml</a>.
This is because small changes in the way matplotlib generates the figure between
versions can sometimes make the tests fail.</p>
<p>For plotting tests, the matplotlib backend is set to <code class="docutils literal notranslate"><span class="pre">agg</span></code> by setting
the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">agg</span></code>. At the first import of
<code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code>, matplotlib will look at the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment
variable and accordingly set the backend.</p>
</section>
<section id="exporting-pytest-results-as-html">
<h2>Exporting pytest results as HTML<a class="headerlink" href="#exporting-pytest-results-as-html" title="Link to this heading">#</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">pytest-html</span></code>, it is possible to export the results of running pytest
for easier viewing. It can be installed by conda:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>conda<span class="w"> </span>install<span class="w"> </span>pytest-html
</pre></div>
</div>
<p>and run by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>--mpl<span class="w"> </span>--html<span class="o">=</span>report.html
</pre></div>
</div>
<p>See <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest-mpl</a> for more details.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="git.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Using Git and GitHub</p>
      </div>
    </a>
    <a class="right-next"
       href="writing_docs.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Writing documentation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-tests">Writing tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tests">Running tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flaky-tests">Flaky tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-coverage">Test coverage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-integration-ci">Continuous integration (CI)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-testing">Plot testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exporting-pytest-results-as-html">Exporting pytest results as HTML</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/dev_guide/testing.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2011-2024, The HyperSpy development team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>